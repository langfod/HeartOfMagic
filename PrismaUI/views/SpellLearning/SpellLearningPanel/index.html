<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="header.title">Heart of Magic</title>
    <!-- Use styles-skyrim.css for native Skyrim UI look, or styles.css for modern dark theme -->
    <link rel="stylesheet" href="styles-skyrim.css">
    <!-- AUTO-TEST FLAG: Set to true to auto-trigger scan+build on panel load (for debugging) -->
    <script>window.AUTO_TEST_BUILD = false;</script>
</head>
<body>
    <!-- Full-screen overlay to block clicks on SWF UI when panel has focus -->
    <div id="focusOverlay" class="focus-overlay" tabindex="-1"></div>
    
    <div id="spellPanel" class="spell-panel">
        <!-- Draggable Header -->
        <div class="panel-header" id="panelHeader">
            <div class="header-left">
                <span class="panel-title" data-i18n="header.panelTitle">HEART OF MAGIC</span>
                <span class="version-tag">v2.0.0</span>
            </div>
            <div class="header-right">
                <button class="header-btn header-btn-wide" id="returnToTreeBtn" style="display:none;" title="Return to Spell Tree" data-i18n="tabs.return" data-i18n-title="tabs.returnTitle">Return</button>
                <button class="header-btn header-btn-wide" id="tabSpellScan" data-tab="spellScan" title="Spell Scanner" data-i18n="tabs.scan" data-i18n-title="tabs.scanTitle">Scan</button>
                <button class="header-btn header-btn-wide" id="tabSettings" data-tab="settings" title="Settings" data-i18n="tabs.settings" data-i18n-title="tabs.settingsTitle">Settings</button>
                <button class="header-btn header-btn-wide header-btn-warn" id="orphanRepairBtn" style="display:none;" title="Orphan nodes detected">0 orphans</button>
                <button class="header-btn" id="fullscreenBtn" title="Toggle Fullscreen" data-i18n-title="buttons.toggleFullscreen">[ ]</button>
                <button class="header-btn" id="closeBtn" title="Close (Esc/Tab)" data-i18n-title="buttons.closeTitle">X</button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="panel-content" id="panelContent">

            <!-- ============================================================ -->
            <!-- PANEL: Spell Scan (toggled from header) -->
            <!-- ============================================================ -->
            <div class="tab-content" id="contentSpellScan">
                <!-- Mode Toggle Bar -->
                <div class="scanner-mode-bar">
                    <button class="scanner-mode-btn active" data-scanner-mode="easy" data-i18n="scanner.modeEasy">EASY</button>
                    <button class="scanner-mode-btn" data-scanner-mode="complex" data-i18n="scanner.modeComplex">COMPLEX</button>
                </div>

                <!-- Shared Status Bar -->
                <div class="scan-status-bar" id="scanStatusBar">
                    <span id="scanStatusText" data-i18n="scanner.readyToScan">Ready to scan</span>
                </div>

                <!-- ============================================================ -->
                <!-- EASY MODE -->
                <!-- ============================================================ -->
                <!-- ============================================================ -->
                <!-- SHARED: Scan Actions + Results/Filters (visible in both modes) -->
                <!-- ============================================================ -->
                <div class="scan-actions-sticky">
                    <button id="scanBtn" class="btn btn-primary" data-i18n-html="buttons.scanSpells">
                        <span class="btn-icon">[*]</span> Scan Spells
                    </button>
                    <button id="saveBtn" class="btn btn-secondary" disabled data-i18n-html="buttons.exportScan">
                        <span class="btn-icon">[S]</span> Export Scan
                    </button>
                </div>

                <!-- Section 1: Scan Results + Filters (split layout) -->
                <div class="scan-section scan-split" id="scanResultsSection">
                    <!-- Left: Scan Stats -->
                    <div class="scan-split-left">
                        <div class="scan-stats-header" data-i18n="scanner.scanResults">Scan Results</div>
                        <div class="scan-stats-grid" id="scanStatsGrid">
                            <div class="scan-stat">
                                <span class="scan-stat-value" id="statTotalSpells">--</span>
                                <span class="scan-stat-label" data-i18n="scanner.totalSpells">Total Spells</span>
                            </div>
                            <div class="scan-stat">
                                <span class="scan-stat-value" id="statTotalMods">--</span>
                                <span class="scan-stat-label" data-i18n="scanner.mods">Mods</span>
                            </div>
                            <div class="scan-stat scan-stat-primed">
                                <span class="scan-stat-value" id="statPrimedSpells">--</span>
                                <span class="scan-stat-label" data-i18n="scanner.primed">Primed</span>
                            </div>
                        </div>
                        <div class="scan-school-breakdown" id="scanSchoolBreakdown">
                            <!-- Populated after scan -->
                        </div>
                    </div>

                    <!-- Right: Filters -->
                    <div class="scan-split-right">
                        <div class="scan-stats-header" data-i18n="filter.title">Filters</div>
                        <div class="scan-filter-controls">
                            <button id="blacklistBtn" class="btn btn-secondary btn-filter" disabled data-i18n-html="filter.blacklist">
                                <span class="btn-icon">[-]</span> Blacklist
                            </button>
                            <button id="whitelistBtn" class="btn btn-secondary btn-filter" disabled data-i18n-html="filter.whitelist">
                                <span class="btn-icon">[+]</span> Whitelist
                            </button>
                            <div class="scan-filter-toggle">
                                <label class="toggle-switch toggle-sm">
                                    <input type="checkbox" id="scanModeTomes">
                                    <span class="toggle-slider"></span>
                                </label>
                                <span class="scan-filter-label" data-i18n="filter.tomesOnly">Tomes only</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ============================================================ -->
                <!-- EASY MODE -->
                <!-- ============================================================ -->
                <div class="scanner-mode-content" id="scannerEasyContent">
                    <div class="easy-panel-split">
                        <div class="easy-panel-left">
                            <div class="easy-presets-section">
                                <div class="easy-presets-label" data-i18n="easyMode.choosePreset">Choose a Preset</div>
                                <div class="easy-preset-chips" id="easyPresetChips"></div>
                            </div>
                            <div class="easy-actions-section">
                                <button id="easyBuildBtn" class="btn btn-success easy-action-btn" disabled data-i18n-html="buttons.buildTree">
                                    <span class="btn-icon">[B]</span> Build Tree
                                </button>
                                <button id="easyApplyBtn" class="btn btn-primary easy-action-btn" disabled data-i18n-html="buttons.applyTree">
                                    <span class="btn-icon">[A]</span> Apply Tree
                                </button>
                                <button id="easyClearBtn" class="btn btn-danger easy-action-btn" disabled data-i18n-html="buttons.clearTree">
                                    <span class="btn-icon">[X]</span> Clear Tree
                                </button>
                                <button id="easyReplayBtn" class="btn easy-action-btn" style="display:none;" data-i18n-html="buttons.replay">
                                    <span class="btn-icon">[R]</span> Replay
                                </button>
                                <span class="easy-status-wrap" data-i18n-html="easyMode.statusWrap">Status: <span id="easyStatus">Waiting for scan...</span></span>
                            </div>
                        </div>
                        <div class="easy-panel-right">
                            <div class="easy-preview-placeholder" id="easyPreviewPlaceholder">
                                <!-- PRM preview canvas is moved here when Easy mode is active -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ============================================================ -->
                <!-- COMPLEX MODE (all existing scanner content) -->
                <!-- ============================================================ -->
                <div class="scanner-mode-content" id="scannerComplexContent" style="display:none;">

                <!-- Section 2: Tree Building -->
                <div class="scan-section" id="treeBuildSection">
                </div>

                <!-- Section 2b: Tree Growth -->
                <div class="scan-section" id="treeGrowthSection">
                </div>

                <!-- Section 3: Output / Details -->
                <div class="scan-section" id="scanDetailsSection">
                </div>

                <!-- Hidden output area used by Export Scan and C++ callbacks -->
                <textarea id="outputArea" style="display:none;"></textarea>

                <!-- ============================================================ -->
                <!-- Section 4: EXTRA SETTINGS (PRM + Alternate Pathways) -->
                <!-- ============================================================ -->
                <div class="scan-section" id="prereqMasterSection" style="display:none;">
                    <div class="settings-block prm-block">
                        <div class="settings-block-header prm-header" id="prmToggleHeader">
                            <span class="settings-block-icon">[+]</span>
                            <span class="settings-block-title" data-i18n="prm.extraSettings">Pre Req Master</span>
                            <span class="prm-collapse-icon">[-]</span>
                        </div>
                        <div class="settings-block-content prm-content" id="prmContent">

                            <!-- Tab Bar (outside scroll zone) -->
                            <div class="prm-tabs">
                                <span class="prm-tab active" data-prm-tab="locks">
                                    <span data-i18n="prm.tabLocks">Pre Req Master</span>
                                    <label class="toggle-switch toggle-sm prm-enable-toggle" title="Enable/Disable Lock Prerequisites">
                                        <input type="checkbox" id="prmEnabled" checked>
                                        <span class="toggle-slider"></span>
                                    </label>
                                </span>
                                <button class="prm-tab" data-prm-tab="core" data-i18n="prm.tabCore">Core</button>
                                <button class="prm-tab not-implemented" data-prm-tab="altpaths" data-i18n="prm.tabAltPaths" title="Not yet implemented">Alternate Pathways</button>
                            </div>

                            <!-- Split: Settings left, Preview right -->
                            <div class="prm-split">
                                <!-- LEFT: Tab content (scrollable) -->
                                <div class="prm-split-left">

                                    <!-- TAB: Pre Req Master (Locks) -->
                                    <div class="prm-tab-content" id="prmTabLocks">

                                        <!-- Action Buttons (at top for easy access) -->
                                        <div class="prm-actions">
                                            <button id="prmApplyBtn" class="btn btn-primary" disabled data-i18n-html="prm.applyLocks">
                                                <span class="btn-icon">[L]</span> Apply Locks
                                            </button>
                                            <button id="prmClearBtn" class="btn btn-secondary" disabled data-i18n-html="prm.clearLocks">
                                                <span class="btn-icon">[X]</span> Clear
                                            </button>
                                            <span id="prmStatus" class="prm-status" data-i18n="prm.buildTreeFirst">Build a tree first</span>
                                        </div>

                                        <!-- A. Global Lock % -->
                                        <div class="setting-row slider-row">
                                            <div class="setting-info">
                                                <span class="setting-label" data-i18n="prm.globalLockPercent">Global Lock %</span>
                                                <span class="setting-desc" data-i18n="prm.globalLockPercentDesc">% of total spells to add lock prereqs to</span>
                                            </div>
                                            <div class="slider-container">
                                                <input type="range" id="prmGlobalLockSlider" min="0" max="100" value="30" step="5" class="setting-slider">
                                                <span id="prmGlobalLockValue" class="slider-value">30%</span>
                                            </div>
                                        </div>

                                        <!-- B. Per-Tier % Controls -->
                                        <div class="settings-subsection">
                                            <span class="subsection-title" data-i18n="prm.lockByTier">Lock % by Tier</span>
                                        </div>
                                        <div class="tier-xp-grid">
                                            <div class="tier-xp-item">
                                                <label for="prmTierNovice" data-i18n="prm.tierNovice">Novice</label>
                                                <input type="number" id="prmTierNovice" class="tier-xp-input" value="0" min="0" max="100">
                                                <span class="tier-xp-unit">%</span>
                                            </div>
                                            <div class="tier-xp-item">
                                                <label for="prmTierApprentice" data-i18n="prm.tierApprentice">Apprentice</label>
                                                <input type="number" id="prmTierApprentice" class="tier-xp-input" value="10" min="0" max="100">
                                                <span class="tier-xp-unit">%</span>
                                            </div>
                                            <div class="tier-xp-item">
                                                <label for="prmTierAdept" data-i18n="prm.tierAdept">Adept</label>
                                                <input type="number" id="prmTierAdept" class="tier-xp-input" value="25" min="0" max="100">
                                                <span class="tier-xp-unit">%</span>
                                            </div>
                                            <div class="tier-xp-item">
                                                <label for="prmTierExpert" data-i18n="prm.tierExpert">Expert</label>
                                                <input type="number" id="prmTierExpert" class="tier-xp-input" value="40" min="0" max="100">
                                                <span class="tier-xp-unit">%</span>
                                            </div>
                                            <div class="tier-xp-item">
                                                <label for="prmTierMaster" data-i18n="prm.tierMaster">Master</label>
                                                <input type="number" id="prmTierMaster" class="tier-xp-input" value="50" min="0" max="100">
                                                <span class="tier-xp-unit">%</span>
                                            </div>
                                        </div>

                                        <!-- C. School Distribution -->
                                        <div class="setting-row">
                                            <div class="setting-info">
                                                <span class="setting-label" data-i18n="prm.schoolDistribution">School Distribution</span>
                                            </div>
                                            <select id="prmSchoolDistribution" class="setting-select">
                                                <option value="proportional" data-i18n="prm.distributionProportional">Proportional</option>
                                                <option value="even" data-i18n="prm.distributionEven">Even</option>
                                                <option value="random" data-i18n="prm.distributionRandom">Random</option>
                                            </select>
                                        </div>

                                        <!-- D. Selection Pool -->
                                        <div class="settings-subsection">
                                            <span class="subsection-title" data-i18n="prm.selectionPool">Selection Pool</span>
                                        </div>
                                        <div class="setting-row">
                                            <div class="setting-info">
                                                <span class="setting-label" data-i18n="prm.poolSource">Pool Source</span>
                                            </div>
                                            <select id="prmPoolSource" class="setting-select">
                                                <option value="same_school" selected data-i18n="prm.poolSameSchool">Same School</option>
                                                <option value="any_school" data-i18n="prm.poolAnySchool">Any School</option>
                                                <option value="nearby" data-i18n="prm.poolNearby">Nearby (layout distance)</option>
                                            </select>
                                        </div>
                                        <div class="setting-pair" id="prmNearbyControls">
                                            <div class="setting-row slider-row">
                                                <div class="setting-info">
                                                    <span class="setting-label" data-i18n="prm.distance">Distance</span>
                                                </div>
                                                <div class="slider-container">
                                                    <input type="range" id="prmDistanceSlider" min="50" max="500" value="200" step="25" class="setting-slider">
                                                    <span id="prmDistanceValue" class="slider-value">200</span>
                                                </div>
                                            </div>
                                            <div class="setting-row slider-row">
                                                <div class="setting-info">
                                                    <span class="setting-label" data-i18n="prm.proximityBias">Proximity Bias</span>
                                                </div>
                                                <div class="slider-container">
                                                    <input type="range" id="prmProximityBiasSlider" min="0" max="100" value="50" step="5" class="setting-slider">
                                                    <span id="prmProximityBiasValue" class="slider-value">50%</span>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- E. Tier Constraints -->
                                        <div class="prm-tier-constraints">
                                            <label class="prm-constraint-toggle">
                                                <input type="checkbox" id="prmSameTier" checked>
                                                <span class="toggle-slider-mini"></span>
                                                <span data-i18n="prm.constraintSame">Same</span>
                                            </label>
                                            <label class="prm-constraint-toggle">
                                                <input type="checkbox" id="prmPrevTier" checked>
                                                <span class="toggle-slider-mini"></span>
                                                <span data-i18n="prm.constraintPrev">Prev</span>
                                            </label>
                                            <label class="prm-constraint-toggle">
                                                <input type="checkbox" id="prmHigherTier">
                                                <span class="toggle-slider-mini"></span>
                                                <span data-i18n="prm.constraintHigher">Higher</span>
                                            </label>
                                            <label class="prm-constraint-toggle">
                                                <input type="checkbox" id="prmAllowLockedLock">
                                                <span class="toggle-slider-mini"></span>
                                                <span data-i18n="prm.constraintChainLocks">Chain Locks</span>
                                            </label>
                                        </div>

                                    </div><!-- /prmTabLocks -->

                                    <!-- TAB: Core Settings (Globe) -->
                                    <div class="prm-tab-content" id="prmTabCore" style="display:none;">
                                        <div class="settings-subsection">
                                            <span class="subsection-title" data-i18n="prm.globePosition">Globe Position</span>
                                        </div>
                                        <div class="setting-row slider-row">
                                            <div class="setting-info">
                                                <span class="setting-label" data-i18n="prm.hOffset">H Offset</span>
                                            </div>
                                            <div class="slider-container">
                                                <input type="range" id="prmGlobeHOffset" min="-500" max="500" value="0" step="5" class="setting-slider">
                                                <span id="prmGlobeHValue" class="slider-value">0</span>
                                            </div>
                                        </div>
                                        <div class="setting-row slider-row">
                                            <div class="setting-info">
                                                <span class="setting-label" data-i18n="prm.vOffset">V Offset</span>
                                            </div>
                                            <div class="slider-container">
                                                <input type="range" id="prmGlobeVOffset" min="-500" max="500" value="0" step="5" class="setting-slider">
                                                <span id="prmGlobeVValue" class="slider-value">0</span>
                                            </div>
                                        </div>
                                        <div class="setting-row slider-row">
                                            <div class="setting-info">
                                                <span class="setting-label" data-i18n="prm.radius">Radius</span>
                                            </div>
                                            <div class="slider-container">
                                                <input type="range" id="prmGlobeRadius" min="10" max="200" value="45" step="5" class="setting-slider">
                                                <span id="prmGlobeRadiusValue" class="slider-value">45</span>
                                            </div>
                                        </div>
                                    </div><!-- /prmTabCore -->

                                    <!-- TAB: Alternate Pathways (placeholder) -->
                                    <div class="prm-tab-content" id="prmTabAltPaths" style="display:none;">
                                        <div class="not-implemented-overlay">
                                            <span class="not-implemented-badge">Not Yet Implemented</span>
                                            <span class="not-implemented-desc">Alternate pathway features are planned for a future update</span>
                                        </div>
                                        <div class="setting-row" style="opacity: 0.35; pointer-events: none;">
                                            <div class="setting-info">
                                                <span class="setting-label" data-i18n="prm.bidirectionalSoftPrereqs">Bidirectional Soft Prerequisites</span>
                                                <span class="setting-desc" data-i18n="prm.bidirectionalSoftPrereqsDesc">Soft prereqs work both ways — mastering either side makes the other learnable</span>
                                            </div>
                                            <label class="toggle-switch">
                                                <input type="checkbox" id="altPathsBidirectional">
                                                <span class="toggle-slider"></span>
                                            </label>
                                        </div>
                                        <div id="altPathsStats" class="prm-status" style="margin-top: 8px; font-size: 11px; color: var(--text-muted);"></div>
                                    </div><!-- /prmTabAltPaths -->

                                </div><!-- /prm-split-left -->

                                <!-- RIGHT: Shared Preview Canvas -->
                                <div class="prm-split-right" id="prmPreviewWrap">
                                    <!-- Canvas created dynamically by prereqMaster.js -->
                                </div>

                            </div><!-- /prm-split -->

                        </div>
                    </div>
                </div>

                <!-- Shared Build/Apply/Clear - Sticky at bottom -->
                <div class="scan-actions-sticky scan-actions-bottom">
                    <!-- Scanner Presets row (hidden when no presets) -->
                    <div id="scannerPresetsRow" class="scanner-presets-row">
                        <span class="scanner-presets-label" data-i18n="presets.title">PRESETS</span>
                        <button id="saveScannerPresetBtn" class="btn btn-sm scanner-preset-save-btn" data-i18n="presets.save">[+] Save</button>
                        <div class="scanner-presets-divider"></div>
                        <div id="scannerPresetChips" class="scanner-preset-chips"></div>
                    </div>
                    <!-- Action buttons -->
                    <div class="scan-actions-buttons">
                        <button id="tgBuildBtn" class="btn btn-success" disabled data-i18n-html="buttons.buildTree">
                            <span class="btn-icon">[B]</span> Build Tree
                        </button>
                        <button id="tgApplyBtn" class="btn btn-primary" disabled data-i18n-html="buttons.applyTree">
                            <span class="btn-icon">[A]</span> Apply Tree
                        </button>
                        <button id="tgClearBtn" class="btn btn-danger" disabled data-i18n-html="buttons.clearTree">
                            <span class="btn-icon">[X]</span> Clear Tree
                        </button>
                        <span style="margin-left:8px; font-size:11px;" data-i18n-html="scanner.complexStatusWrap">Status: <span id="tgStatus" style="color:rgba(184,168,120,0.5);">Waiting for scan...</span></span>
                    </div>
                </div>

                </div><!-- /scannerComplexContent -->
            </div>

            <!-- ============================================================ -->
            <!-- PANEL: Spell Tree (default view) -->
            <!-- ============================================================ -->
            <div class="tab-content active" id="contentSpellTree">
                <!-- Tree Container -->
                <div id="tree-container" class="tree-container">
                    <svg id="tree-svg" class="tree-svg">
                        <defs>
                            <!-- Arrow markers -->
                            <marker id="arrow" markerWidth="6" markerHeight="6" refX="5" refY="3" 
                                    orient="auto" markerUnits="strokeWidth">
                                <path d="M0,0 L0,6 L6,3 z" fill="#334155"/>
                            </marker>
                            <marker id="arrow-active" markerWidth="6" markerHeight="6" refX="5" refY="3" 
                                    orient="auto" markerUnits="strokeWidth">
                                <path d="M0,0 L0,6 L6,3 z" fill="#fbbf24"/>
                            </marker>
                            
                            <!-- Glow filter -->
                            <filter id="glow" x="-50%" y="-50%" width="200%" height="200%">
                                <feGaussianBlur stdDeviation="6" result="blur"/>
                                <feMerge>
                                    <feMergeNode in="blur"/>
                                    <feMergeNode in="SourceGraphic"/>
                                </feMerge>
                            </filter>
                        </defs>
                        
                        <!-- Main rotating group -->
                        <g id="wheel-group">
                            <!-- School spoke backgrounds -->
                            <g id="spokes-layer"></g>
                            
                            <!-- Edges rendered behind nodes -->
                            <g id="edges-layer"></g>
                            
                            <!-- Nodes rendered on top -->
                            <g id="nodes-layer"></g>
                        </g>
                        
                        <!-- Center hub (separate so it doesn't rotate) -->
                        <g id="center-hub"></g>
                    </svg>
                    
                    <!-- Zoom Controls -->
                    <div class="zoom-controls">
                        <button id="zoom-in" class="zoom-btn" title="Zoom In" data-i18n-title="buttons.zoomIn">+</button>
                        <span id="zoom-level">100%</span>
                        <button id="zoom-out" class="zoom-btn" title="Zoom Out" data-i18n-title="buttons.zoomOut">−</button>
                        <span id="renderer-badge" class="renderer-badge canvas" title="Renderer: CANVAS (Canvas 2D)" data-i18n-title="buttons.activeRenderer">Canvas</span>
                        <button id="heart-settings-btn" class="zoom-btn" title="Heart Animation Settings" data-i18n-title="buttons.heartSettings">⚙</button>
                        <button id="edit-tree-btn" class="zoom-btn" title="Edit Tree" data-i18n-title="buttons.editTree">✎</button>
                        <span id="edit-tools" class="edit-tools" style="display: none;">
                            <button id="edit-tool-move" class="zoom-btn edit-tool active" title="Move Tool" data-i18n-title="buttons.moveTool">✥</button>
                            <button id="edit-tool-pen" class="zoom-btn edit-tool" title="Pen Tool - Draw Prerequisites" data-i18n-title="buttons.penTool">✒</button>
                            <button id="edit-tool-eraser" class="zoom-btn edit-tool" title="Eraser Tool - Remove Links" data-i18n-title="buttons.eraserTool">⌫</button>
                        </span>
                    </div>
                    
                    <!-- Render Customization Settings Popup -->
                    <div id="heart-settings-popup" class="heart-settings-popup" style="display: none;">
                        <div class="popup-header">
                            <span data-i18n="settings.render.title">Render Customizations</span>
                            <button id="heart-settings-close" class="popup-close">×</button>
                        </div>
                        <div class="popup-content">
                            <!-- Core (Heart + Globe unified) -->
                            <div class="popup-section-title" data-i18n="settings.render.coreSection">Core</div>
                            <div class="popup-row-2">
                                <div class="popup-cell"><label data-i18n="settings.render.coreSize">Core Size</label>
                                    <input type="range" id="popup-core-size" min="20" max="80" step="5" value="50">
                                    <span id="popup-core-size-val">50</span></div>
                                <div class="popup-cell"><label data-i18n="settings.render.particles">Particles</label>
                                    <input type="range" id="popup-globe-density" min="25" max="500" step="25" value="50">
                                    <span id="popup-globe-density-val">50</span></div>
                            </div>
                            <div class="popup-row">
                                <div class="popup-cell"><label data-i18n="settings.render.globeSize">Globe Size</label>
                                    <input type="range" id="popup-globe-particle-radius" min="10" max="150" step="5" value="50">
                                    <span id="popup-globe-particle-radius-val">50</span></div>
                            </div>
                            <div class="popup-row-4">
                                <div class="popup-cell"><label data-i18n="settings.render.animate">Animate</label>
                                    <label class="toggle-switch toggle-sm"><input type="checkbox" id="heart-animation-enabled" checked><span class="toggle-slider"></span></label></div>
                                <div class="popup-cell"><label data-i18n="settings.render.bgFill">Bg Fill</label>
                                    <label class="toggle-switch toggle-sm"><input type="checkbox" id="popup-globe-bg-fill" checked><span class="toggle-slider"></span></label></div>
                                <div class="popup-cell"><label data-i18n="settings.render.trail">Trail</label>
                                    <label class="toggle-switch toggle-sm"><input type="checkbox" id="popup-particle-trail" checked><span class="toggle-slider"></span></label></div>
                                <div class="popup-cell"><label>Core</label>
                                    <label class="toggle-switch toggle-sm"><input type="checkbox" id="popup-particle-core"><span class="toggle-slider"></span></label></div>
                            </div>
                            <div class="popup-row-2">
                                <div class="popup-cell"><label data-i18n="settings.render.speed">Speed</label>
                                    <input type="range" id="heart-pulse-speed" min="0" max="1" step="0.05" value="0.5">
                                    <span id="heart-pulse-speed-val">0.50</span></div>
                                <div class="popup-cell"><label data-i18n="settings.render.delay">Delay</label>
                                    <input type="range" id="heart-pulse-delay" min="0" max="5" step="0.25" value="2.75">
                                    <span id="heart-pulse-delay-val">2.75s</span></div>
                            </div>
                            <div class="popup-row-2">
                                <div class="popup-cell"><label data-i18n="settings.render.dotMin">Dot Min</label>
                                    <input type="range" id="popup-globe-dot-min" min="0.5" max="3" step="0.5" value="0.5">
                                    <span id="popup-globe-dot-min-val">0.5</span></div>
                                <div class="popup-cell"><label data-i18n="settings.render.dotMax">Dot Max</label>
                                    <input type="range" id="popup-globe-dot-max" min="0.5" max="6" step="0.5" value="1">
                                    <span id="popup-globe-dot-max-val">1</span></div>
                            </div>
                            <div class="popup-row-3">
                                <div class="popup-cell"><label data-i18n="settings.render.coreBg">Bg</label>
                                    <div class="color-swatch" id="heart-bg-color-swatch" data-target="heart-bg-color" style="background: #000000;"></div>
                                    <input type="hidden" id="heart-bg-color" value="#000000"></div>
                                <div class="popup-cell"><label data-i18n="settings.render.ring">Ring</label>
                                    <div class="color-swatch" id="heart-ring-color-swatch" data-target="heart-ring-color" style="background: #b8a878;"></div>
                                    <input type="hidden" id="heart-ring-color" value="#b8a878"></div>
                                <div class="popup-cell"><label data-i18n="settings.render.globe">Globe</label>
                                    <div class="color-swatch" id="globe-color-swatch" data-target="popup-globe-color" style="background: #b8a878;"></div>
                                    <input type="hidden" id="popup-globe-color" value="#b8a878"></div>
                            </div>
                            <div class="popup-row-3">
                                <div class="popup-cell"><label data-i18n="settings.render.pathColor">Path</label>
                                    <div class="color-swatch" id="learning-path-color-swatch" data-target="learning-path-color" style="background: #00ffff;"></div>
                                    <input type="hidden" id="learning-path-color" value="#00ffff"></div>
                                <div class="popup-cell"><label data-i18n="settings.render.textColor">Txt</label>
                                    <div class="color-swatch" id="magic-text-color-swatch" data-target="popup-magic-text-color" style="background: #ffecb3;"></div>
                                    <input type="hidden" id="popup-magic-text-color" value="#ffecb3"></div>
                                <div class="popup-cell"><label data-i18n="settings.render.textSize">TxtSz</label>
                                    <input type="range" id="popup-globe-text-size" min="8" max="32" step="1" value="16">
                                    <span id="popup-globe-text-size-val">16</span></div>
                            </div>
                            <div class="popup-row">
                                <label data-i18n="settings.render.globeText">Globe Text</label>
                                <input type="text" id="popup-globe-text" class="popup-input" value="HEART" data-i18n-placeholder="settings.render.globeTextPlaceholder" placeholder="Text (use \n for line breaks)">
                            </div>
                            <!-- Starfield -->
                            <div class="popup-divider"></div>
                            <div class="popup-section-title" data-i18n="settings.render.starfield">Starfield</div>
                            <div class="popup-row-3">
                                <div class="popup-cell"><label data-i18n="settings.render.enable">Enable</label>
                                    <label class="toggle-switch toggle-sm"><input type="checkbox" id="starfield-enabled" checked><span class="toggle-slider"></span></label></div>
                                <div class="popup-cell"><label data-i18n="settings.render.fixed">Fixed</label>
                                    <label class="toggle-switch toggle-sm"><input type="checkbox" id="starfield-fixed"><span class="toggle-slider"></span></label></div>
                                <div class="popup-cell"><label data-i18n="settings.render.color">Color</label>
                                    <div class="color-swatch" id="starfield-color-swatch" data-target="starfield-color" style="background: #ffffff;"></div>
                                    <input type="hidden" id="starfield-color" value="#ffffff"></div>
                            </div>
                            <div class="popup-row-2">
                                <div class="popup-cell"><label data-i18n="settings.render.density">Density</label>
                                    <input type="range" id="starfield-density" min="50" max="500" step="25" value="250">
                                    <span id="starfield-density-val">250</span></div>
                                <div class="popup-cell"><label data-i18n="settings.render.size">Size</label>
                                    <input type="range" id="starfield-size" min="0.5" max="5" step="0.5" value="3">
                                    <span id="starfield-size-val">3</span></div>
                            </div>
                            <div class="popup-row-2">
                                <div class="popup-cell"><label data-i18n="settings.render.seed">Seed</label>
                                    <input type="range" id="starfield-seed" min="1" max="999" step="1" value="42">
                                    <span id="starfield-seed-val">42</span></div>
                                <div class="popup-cell"><label data-i18n="settings.render.starfieldBg">Bg</label>
                                    <div class="color-swatch" id="starfield-bg-color-swatch" data-target="starfield-bg-color" style="background: #000000;"></div>
                                    <input type="hidden" id="starfield-bg-color" value="#000000">
                                    <button class="popup-apply-btn" id="starfield-bg-apply" data-i18n="settings.render.apply" title="Apply">Apply</button></div>
                            </div>

                            <!-- Connections -->
                            <div class="popup-divider"></div>
                            <div class="popup-section-title" data-i18n="settings.render.connections">Connections</div>

                            <div class="popup-row-2">
                                <div class="popup-cell">
                                    <label data-i18n="settings.render.selPath">Sel. Path</label>
                                    <label class="toggle-switch toggle-sm">
                                        <input type="checkbox" id="show-selection-path" checked>
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                <div class="popup-cell">
                                    <label data-i18n="settings.render.baseLines">Base Lines</label>
                                    <label class="toggle-switch toggle-sm">
                                        <input type="checkbox" id="show-base-connections" checked>
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                            </div>
                            <div class="popup-row-2">
                                <div class="popup-cell">
                                    <label>Curved Edges</label>
                                    <label class="toggle-switch toggle-sm">
                                        <input type="checkbox" id="edge-style-toggle">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                <div class="popup-cell"></div>
                            </div>

                            <!-- Nodes -->
                            <div class="popup-divider"></div>
                            <div class="popup-section-title" data-i18n="settings.render.nodes">Nodes</div>

                            <div class="popup-row-2">
                                <div class="popup-cell">
                                    <label data-i18n="settings.render.names">Names</label>
                                    <label class="toggle-switch toggle-sm">
                                        <input type="checkbox" id="popup-show-node-names" checked>
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                <div class="popup-cell">
                                    <label data-i18n="settings.render.font">Font</label>
                                    <input type="range" id="popup-node-font-size" min="6" max="18" step="1" value="10">
                                    <span id="popup-node-font-size-val">10</span>
                                </div>
                            </div>

                            <!-- Tree Colors -->
                            <div class="popup-divider"></div>
                            <div class="popup-section-title" data-i18n="settings.render.treeColors">Tree Colors</div>

                            <div class="tree-color-row">
                                <div class="tree-color-item">
                                    <div class="color-swatch" id="tree-color-destruction-swatch" data-target="tree-color-destruction" style="background: #ef4444;"></div>
                                    <input type="hidden" id="tree-color-destruction" value="#ef4444">
                                    <span>Destr</span>
                                </div>
                                <div class="tree-color-item">
                                    <div class="color-swatch" id="tree-color-restoration-swatch" data-target="tree-color-restoration" style="background: #facc15;"></div>
                                    <input type="hidden" id="tree-color-restoration" value="#facc15">
                                    <span>Rest</span>
                                </div>
                                <div class="tree-color-item">
                                    <div class="color-swatch" id="tree-color-alteration-swatch" data-target="tree-color-alteration" style="background: #22c55e;"></div>
                                    <input type="hidden" id="tree-color-alteration" value="#22c55e">
                                    <span>Alter</span>
                                </div>
                                <div class="tree-color-item">
                                    <div class="color-swatch" id="tree-color-conjuration-swatch" data-target="tree-color-conjuration" style="background: #a855f7;"></div>
                                    <input type="hidden" id="tree-color-conjuration" value="#a855f7">
                                    <span>Conj</span>
                                </div>
                                <div class="tree-color-item">
                                    <div class="color-swatch" id="tree-color-illusion-swatch" data-target="tree-color-illusion" style="background: #38bdf8;"></div>
                                    <input type="hidden" id="tree-color-illusion" value="#38bdf8">
                                    <span>Illus</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Color Picker Modal -->
                    <div id="color-picker-modal" class="color-picker-modal" style="display: none;">
                        <div class="color-picker-content">
                            <div class="color-picker-header">
                                <span data-i18n="settings.colorPicker.title">Select Color</span>
                                <button id="color-picker-close" class="popup-close">×</button>
                            </div>
                            <div class="color-picker-body">
                                <div class="color-gradient" id="color-gradient">
                                    <div class="color-gradient-cursor" id="color-gradient-cursor"></div>
                                </div>
                                <div class="color-hue-bar" id="color-hue-bar">
                                    <div class="color-hue-cursor" id="color-hue-cursor"></div>
                                </div>
                                <div class="color-preview-row">
                                    <div class="color-preview" id="color-preview"></div>
                                    <input type="text" id="color-hex-input" class="color-hex-input" value="#ffffff" maxlength="7">
                                </div>
                                <div class="color-presets">
                                    <div class="color-preset" style="background: #ff0000;" data-color="#ff0000"></div>
                                    <div class="color-preset" style="background: #ff8800;" data-color="#ff8800"></div>
                                    <div class="color-preset" style="background: #ffff00;" data-color="#ffff00"></div>
                                    <div class="color-preset" style="background: #00ff00;" data-color="#00ff00"></div>
                                    <div class="color-preset" style="background: #00ffff;" data-color="#00ffff"></div>
                                    <div class="color-preset" style="background: #0088ff;" data-color="#0088ff"></div>
                                    <div class="color-preset" style="background: #8800ff;" data-color="#8800ff"></div>
                                    <div class="color-preset" style="background: #ff00ff;" data-color="#ff00ff"></div>
                                    <div class="color-preset" style="background: #ffffff;" data-color="#ffffff"></div>
                                    <div class="color-preset" style="background: #b8a878;" data-color="#b8a878"></div>
                                    <div class="color-preset" style="background: #1a1a2e;" data-color="#1a1a2e"></div>
                                    <div class="color-preset" style="background: #0a0a14;" data-color="#0a0a14"></div>
                                </div>
                                <button id="color-picker-apply" class="btn btn-primary btn-sm" data-i18n="settings.colorPicker.apply">Apply</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tree Instructions -->
                    <div class="tree-instructions">
                        <span data-i18n="tree.instructions">Drag to pan / Scroll to zoom / Click node to select</span>
                    </div>
                    
                    <!-- Empty State -->
                    <div id="empty-state" class="empty-state">
                        <div class="empty-icon">*</div>
                        <div class="empty-text" data-i18n="tree.emptyState.title">No spell tree loaded</div>
                        <div class="empty-hint" data-i18n="tree.emptyState.hint">Scan your spells and build a tree to get started.</div>
                        <button id="go-to-scanner-btn" class="btn btn-primary" data-i18n="tree.emptyState.goToScanner">Go to Scanner</button>
                    </div>
                    
                </div>

                <!-- Spell Details Sidebar -->
                <div id="details-panel" class="details-panel hidden">
                    <div class="details-close">
                        <button id="close-details" class="header-btn">×</button>
                    </div>
                    <div class="details-header">
                        <h3 id="spell-name">-</h3>
                        <span id="spell-school" class="school-badge">-</span>
                    </div>
                    
                    <div class="details-body">
                        <div class="detail-row">
                            <span class="detail-label" data-i18n="details.level">Level</span>
                            <span id="spell-level" class="detail-value">-</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label" data-i18n="details.magicka">Magicka</span>
                            <span id="spell-cost" class="detail-value">-</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label" data-i18n="details.type">Type</span>
                            <span id="spell-type" class="detail-value">-</span>
                        </div>
                        
                        <div class="detail-section">
                            <span class="detail-label" data-i18n="details.effects">Effects</span>
                            <ul id="spell-effects" class="detail-list"></ul>
                        </div>
                        
                        <div class="detail-section">
                            <span class="detail-label" data-i18n="details.description">Description</span>
                            <p id="spell-description" class="detail-desc">-</p>
                        </div>
                        
                        <div class="detail-section prereq-section">
                            <span class="detail-label" data-i18n="details.prerequisites">Prerequisites</span>
                            <div id="prereq-summary" class="prereq-summary"></div>
                            <div id="hard-prereqs-section" class="prereq-group hidden">
                                <span class="prereq-type-label hard" data-i18n="details.prereqRequiredAll">Required (all)</span>
                                <ul id="hard-prereqs-list" class="detail-list clickable"></ul>
                            </div>
                            <div id="soft-prereqs-section" class="prereq-group hidden">
                                <span class="prereq-type-label soft" data-i18n="details.prereqOptional">Optional <span id="soft-needed-count"></span></span>
                                <ul id="soft-prereqs-list" class="detail-list clickable"></ul>
                            </div>
                            <ul id="spell-prereqs" class="detail-list clickable hidden"></ul>
                        </div>
                        
                        <div class="detail-section">
                            <span class="detail-label" data-i18n="details.unlocks">Unlocks</span>
                            <ul id="spell-unlocks" class="detail-list clickable"></ul>
                        </div>
                        
                        <div class="detail-section" id="locks-section" style="display:none;">
                            <span class="detail-label" data-i18n="details.locks">Locks <span class="lock-label" data-i18n="details.lockBadge">LOCK</span></span>
                            <ul id="locks-list" class="detail-list clickable"></ul>
                        </div>
                    </div>
                    
                    <!-- XP Progress Section -->
                    <div id="progress-section" class="progress-section hidden">
                        <!-- Learning Status Badge -->
                        <div id="learning-status-container" class="learning-status-container">
                            <span id="learning-status-badge" class="learning-status-badge locked" data-i18n="details.statusLocked">LOCKED</span>
                            <span id="learning-effectiveness" class="learning-effectiveness"></span>
                        </div>
                        <div id="learning-status-hint" class="learning-status-hint"></div>
                        
                        <div class="progress-label">
                            <span data-i18n="details.learningProgress">Learning Progress</span>
                            <span id="progress-text" class="progress-text-normal">0 / 100 XP</span>
                            <!-- Editable XP inputs for cheat mode -->
                            <span id="progress-edit" class="progress-edit hidden">
                                <input type="number" id="xp-current-input" class="xp-input" min="0" value="0">
                                <span>/</span>
                                <input type="number" id="xp-required-input" class="xp-input xp-required" min="1" value="100">
                                <span>XP</span>
                            </span>
                        </div>
                        <div class="progress-bar-container">
                            <div id="progress-bar" class="progress-bar" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <div class="details-footer">
                        <span id="spell-state" class="state-badge locked" data-i18n="details.stateLocked">Locked</span>
                        <button id="learn-btn" class="btn btn-learn hidden" data-i18n="details.learnThis">Learn This</button>
                        <button id="unlock-btn" class="btn btn-unlock hidden" disabled data-i18n="details.unlockSpell">Unlock Spell</button>
                    </div>
                </div>

                <!-- How-to-Learn Info Panel (opposite side) -->
                <div id="howto-panel" class="howto-panel hidden">
                    <div class="howto-tab" id="howto-tab">
                        <span class="howto-tab-icon">?</span>
                        <span class="howto-tab-text" data-i18n="howto.tabText">How to Learn</span>
                    </div>
                    <div class="howto-content">
                        <div class="howto-header">
                            <h3 data-i18n="howto.title">How to Learn Spells</h3>
                            <button id="close-howto" class="header-btn">×</button>
                        </div>
                        
                        <div class="howto-section">
                            <h4 data-i18n="howto.currentSettings">[i] Current Settings</h4>
                            <ul id="howto-settings-list" class="howto-list">
                                <li>Loading...</li>
                            </ul>
                        </div>
                        
                        <div class="howto-section">
                            <h4 data-i18n="howto.gainingXp">[^] Gaining XP</h4>
                            <ul id="howto-xp-list" class="howto-list">
                                <li>Loading...</li>
                            </ul>
                        </div>
                        
                        <div class="howto-section">
                            <h4 data-i18n="howto.tips">(!) Tips</h4>
                            <ul id="howto-tips-list" class="howto-list">
                                <li data-i18n="howto.tipSetTargets">Set learning targets (one per school)</li>
                                <li data-i18n="howto.tipCombatXp">Combat usage grants more XP than practice</li>
                                <li data-i18n="howto.tipOwnTomes">Own spell tomes for passive XP boost</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Tree Footer -->
                <div class="tree-footer">
                    <div class="footer-left">
                        <button id="import-btn" class="btn btn-secondary btn-sm">
                            <span class="btn-icon">[v]</span> <span data-i18n="footer.import">Import</span>
                        </button>
                        <button id="llm-toolbar-btn" class="btn btn-llm btn-sm hidden" data-i18n-title="footer.llmTitle" title="Auto-generate trees via LLM">
                            <span class="btn-icon">[AI]</span> <span data-i18n="footer.llm">LLM</span>
                        </button>
                        <span class="spell-count">
                            <span id="total-count">0</span> <span data-i18n="footer.spellsLabel">spells</span> |
                            <span id="unlocked-count">0</span> <span data-i18n="footer.unlockedLabel">unlocked</span>
                        </span>
                    </div>
                    <div class="footer-center">
                        <div class="state-legend">
                            <span class="legend-item locked"><span class="legend-dot"></span><span data-i18n="footer.legendLocked">Locked</span></span>
                            <span class="legend-item available"><span class="legend-dot"></span><span data-i18n="footer.legendAvailable">Available</span></span>
                            <span class="legend-item learning"><span class="legend-dot"></span><span data-i18n="footer.legendLearning">Learning</span></span>
                            <span class="legend-item unlocked"><span class="legend-dot"></span><span data-i18n="footer.legendUnlocked">Unlocked</span></span>
                        </div>
                    </div>
                    <div class="footer-right">
                        <span id="tree-status-text" class="status-text" data-i18n="footer.statusReady">Ready</span>
                    </div>
                </div>
            </div>

            <!-- ============================================================ -->
            <!-- TAB: Settings -->
            <!-- ============================================================ -->
            <div class="tab-content" id="contentSettings">
                <!-- ===== ROW 1: Hotkey + UI Display ===== -->
                <div class="settings-split">
                    <!-- Hotkey Settings -->
                    <div class="settings-block">
                        <div class="settings-block-header">
                            <span class="settings-block-icon">[K]</span>
                            <span class="settings-block-title" data-i18n="settings.hotkey.title">Hotkey</span>
                        </div>
                        <div class="settings-block-content">
                            <div class="setting-row">
                                <div class="setting-info">
                                    <span class="setting-label" data-i18n="settings.hotkey.panelToggleKey">Panel Toggle Key</span>
                                </div>
                                <div class="hotkey-input-group">
                                    <input type="text" id="hotkeyInput" class="hotkey-input" value="F8" readonly>
                                    <button id="changeHotkeyBtn" class="btn btn-secondary btn-sm" data-i18n="settings.hotkey.change">Change</button>
                                    <button id="resetHotkeyBtn" class="btn btn-secondary btn-sm" data-i18n="settings.hotkey.reset">Reset</button>
                                </div>
                            </div>
                            <div class="setting-row">
                                <div class="setting-info">
                                    <span class="setting-label" data-i18n="settings.hotkey.pauseGameOnOpen">Pause Game on Open</span>
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="pauseGameOnFocusToggle" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                    </div>
                    <!-- UI Display Settings -->
                    <div class="settings-block">
                        <div class="settings-block-header">
                            <span class="settings-block-icon">[~]</span>
                            <span class="settings-block-title" data-i18n="settings.ui.title">UI Display</span>
                        </div>
                        <div class="settings-block-content">
                            <div class="setting-row">
                                <div class="setting-info">
                                    <span class="setting-label" data-i18n="settings.ui.theme">UI Theme</span>
                                </div>
                                <div class="theme-selector-row">
                                    <select id="uiThemeSelect" class="setting-select">
                                        <!-- Options populated dynamically from themes/ folder -->
                                    </select>
                                    <button id="refreshThemesBtn" class="btn btn-sm btn-icon" data-i18n-title="settings.ui.refreshThemesTitle" title="Rescan themes folder">[R]</button>
                                </div>
                            </div>
                            <div class="setting-row">
                                <div class="setting-info">
                                    <span class="setting-label" data-i18n="settings.ui.learningColor">Learning Color</span>
                                </div>
                                <div class="color-picker-wrapper">
                                    <input type="color" id="learningColorPicker" class="color-picker" value="#7890A8">
                                    <span class="color-value" id="learningColorValue">#7890A8</span>
                                </div>
                            </div>
                            <div class="setting-row">
                                <div class="setting-info">
                                    <span class="setting-label" data-i18n="settings.ui.fontSize">Font Size</span>
                                </div>
                                <div class="slider-with-value">
                                    <input type="range" id="fontSizeSlider" class="setting-slider" min="0.7" max="1.5" step="0.1" value="1.0">
                                    <span class="slider-value" id="fontSizeValue">1.0x</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Settings Presets - controls Progression, Early Spell, Spell Tome -->
                <div id="settingsPresetsRow" class="scanner-presets-row settings-presets-header">
                    <span class="scanner-presets-label" data-i18n="settings.presets.label">PRESETS</span>
                    <button id="saveSettingsPresetBtn" class="btn btn-sm scanner-preset-save-btn" data-i18n="settings.presets.save">[+] Save</button>
                    <div class="scanner-presets-divider"></div>
                    <div id="settingsPresetChips" class="scanner-preset-chips"></div>
                </div>

                <!-- ===== ROW 2: Progression + Early Learning ===== -->
                <div class="settings-split">
                <!-- Progression Settings -->
                <div class="settings-block">
                    <div class="settings-block-header">
                        <span class="settings-block-icon">[^]</span>
                        <span class="settings-block-title" data-i18n="settings.progression.title">Progression Settings</span>
                    </div>
                    <div class="settings-block-content">
                        <div class="settings-subsection" style="margin-top: 0; padding-top: 0; border-top: none;">
                            <span class="subsection-title" data-i18n="settings.progression.xpSettings">XP Settings</span>
                        </div>
                        
                        <!-- Learning Mode + Discovery Mode (paired) -->
                        <div class="setting-pair">
                            <div class="setting-row">
                                <div class="setting-info">
                                    <span class="setting-label" data-i18n="settings.progression.learningMode">Learning Mode</span>
                                    <span class="setting-desc" data-i18n="settings.progression.learningModeDesc">How many spells learned at once</span>
                                </div>
                                <div id="learningModeToggle" class="segmented-toggle">
                                    <div class="seg-btn active" data-value="perSchool">Per School</div>
                                    <div class="seg-btn" data-value="single">Single</div>
                                </div>
                            </div>
                            <div class="setting-row">
                                <div class="setting-info">
                                    <span class="setting-label" data-i18n="settings.progression.discoveryMode">Discovery Mode</span>
                                    <span class="setting-desc" data-i18n="settings.progression.discoveryModeDesc">Hide locked nodes until progress</span>
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="discoveryModeToggle">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                        <div class="setting-row" id="showRootNamesRow">
                            <div class="setting-info">
                                <span class="setting-label" data-i18n="settings.progression.showRootSpellNames">Show Root Spell Names</span>
                                <span class="setting-desc" data-i18n="settings.progression.showRootSpellNamesDesc">Reveal starting spell names even in discovery mode</span>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="showRootSpellNamesToggle" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>

                        <!-- Auto-Advance Learning Target -->
                        <div class="setting-row">
                            <div class="setting-info">
                                <span class="setting-label">Auto-Advance Target</span>
                                <span class="setting-desc">When a spell is mastered, auto-learn the next available spell</span>
                            </div>
                            <div style="display:flex; align-items:center; gap:8px;">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="autoAdvanceLearningToggle" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                                <div id="autoAdvanceModeToggle" class="segmented-toggle">
                                    <div class="seg-btn active" data-value="branch">Branch</div>
                                    <div class="seg-btn" data-value="random">Random</div>
                                </div>
                            </div>
                        </div>

                        <!-- Overall XP Multiplier -->
                        <div class="setting-row slider-row">
                            <div class="setting-info">
                                <span class="setting-label" data-i18n="settings.progression.overallXpMultiplier">Overall XP Multiplier</span>
                                <span class="setting-desc" data-i18n="settings.progression.overallXpMultiplierDesc">Multiply all XP gains (for faster/slower progression)</span>
                            </div>
                            <div class="slider-container">
                                <input type="range" id="xpGlobalMultiplierSlider" min="1" max="1000" value="1" class="setting-slider">
                                <span id="xpGlobalMultiplierValue" class="slider-value">x1</span>
                            </div>
                        </div>
                        
                        <!-- XP Multipliers (compact 3-column grid) -->
                        <div class="slider-grid slider-grid-3">
                            <div class="slider-compact" data-i18n-title="settings.progression.directPrereqXpTitle" title="Casting a spell that directly leads to the learning target">
                                <span class="slider-compact-label" data-i18n="settings.progression.directPrereqXp">Direct Prereq XP</span>
                                <div class="slider-compact-control">
                                    <input type="range" id="xpDirectSlider" min="0" max="100" value="100" class="setting-slider">
                                    <span id="xpDirectValue" class="slider-value">100%</span>
                                </div>
                            </div>
                            <div class="slider-compact" data-i18n-title="settings.progression.sameSchoolXpTitle" title="Casting any spell from the same magic school">
                                <span class="slider-compact-label" data-i18n="settings.progression.sameSchoolXp">Same School XP</span>
                                <div class="slider-compact-control">
                                    <input type="range" id="xpSchoolSlider" min="0" max="100" value="50" class="setting-slider">
                                    <span id="xpSchoolValue" class="slider-value">50%</span>
                                </div>
                            </div>
                            <div class="slider-compact" data-i18n-title="settings.progression.anySpellXpTitle" title="Casting spells from any magic school">
                                <span class="slider-compact-label" data-i18n="settings.progression.anySpellXp">Any Spell XP</span>
                                <div class="slider-compact-control">
                                    <input type="range" id="xpAnySlider" min="0" max="100" value="10" class="setting-slider">
                                    <span id="xpAnyValue" class="slider-value">10%</span>
                                </div>
                            </div>
                        </div>
                        <p class="setting-note" data-i18n="settings.progression.multipliersNote">Multipliers determine how much XP you gain per cast.</p>
                        
                        <!-- XP Caps - Max contribution from each source -->
                        <div class="settings-subsection">
                            <span class="subsection-title" data-i18n="settings.progression.xpCaps">XP Caps (Maximum Contribution)</span>
                        </div>
                        
                        <p class="setting-note" data-i18n="settings.progression.xpCapsNote">Caps limit how much total progress each source can provide. Once a cap is reached, you must use other sources.</p>
                        
                        <!-- XP Caps (compact 3-column grid) -->
                        <div class="slider-grid slider-grid-3">
                            <div class="slider-compact" data-i18n-title="settings.progression.maxAnySpellTitle" title="After this %, 'any spell' XP stops contributing">
                                <span class="slider-compact-label" data-i18n="settings.progression.maxAnySpell">Max Any Spell</span>
                                <div class="slider-compact-control">
                                    <input type="range" id="xpCapAnySlider" min="0" max="100" value="5" class="setting-slider">
                                    <span id="xpCapAnyValue" class="slider-value">5%</span>
                                </div>
                            </div>
                            <div class="slider-compact" data-i18n-title="settings.progression.maxSameSchoolTitle" title="After this %, 'same school' XP stops contributing">
                                <span class="slider-compact-label" data-i18n="settings.progression.maxSameSchool">Max Same School</span>
                                <div class="slider-compact-control">
                                    <input type="range" id="xpCapSchoolSlider" min="0" max="100" value="15" class="setting-slider">
                                    <span id="xpCapSchoolValue" class="slider-value">15%</span>
                                </div>
                            </div>
                            <div class="slider-compact" data-i18n-title="settings.progression.maxDirectPrereqTitle" title="After this %, prerequisite XP stops contributing">
                                <span class="slider-compact-label" data-i18n="settings.progression.maxDirectPrereq">Max Direct Prereq</span>
                                <div class="slider-compact-control">
                                    <input type="range" id="xpCapDirectSlider" min="0" max="100" value="50" class="setting-slider">
                                    <span id="xpCapDirectValue" class="slider-value">50%</span>
                                </div>
                            </div>
                        </div>
                        
                        <p class="setting-note" data-i18n="settings.progression.xpCapsExample">Example: With caps at 5%/15%/50%, the final 50% must come from casting the spell itself.</p>

                        <!-- XP Required per Tier -->
                        <div class="settings-subsection">
                            <span class="subsection-title" data-i18n="settings.progression.xpRequiredByTier">XP Required by Spell Tier</span>
                        </div>
                        
                        <div class="tier-xp-grid">
                            <div class="tier-xp-item">
                                <label for="xpNoviceInput" data-i18n="settings.progression.tierNovice">Novice</label>
                                <input type="number" id="xpNoviceInput" class="tier-xp-input" value="100" min="1" max="99999">
                            </div>
                            <div class="tier-xp-item">
                                <label for="xpApprenticeInput" data-i18n="settings.progression.tierApprentice">Apprentice</label>
                                <input type="number" id="xpApprenticeInput" class="tier-xp-input" value="200" min="1" max="99999">
                            </div>
                            <div class="tier-xp-item">
                                <label for="xpAdeptInput" data-i18n="settings.progression.tierAdept">Adept</label>
                                <input type="number" id="xpAdeptInput" class="tier-xp-input" value="400" min="1" max="99999">
                            </div>
                            <div class="tier-xp-item">
                                <label for="xpExpertInput" data-i18n="settings.progression.tierExpert">Expert</label>
                                <input type="number" id="xpExpertInput" class="tier-xp-input" value="800" min="1" max="99999">
                            </div>
                            <div class="tier-xp-item">
                                <label for="xpMasterInput" data-i18n="settings.progression.tierMaster">Master</label>
                                <input type="number" id="xpMasterInput" class="tier-xp-input" value="1500" min="1" max="99999">
                            </div>
                        </div>
                        
                        <!-- Passive Learning -->
                        <div class="settings-subsection passive-learning-section">
                            <span class="subsection-title" data-i18n="settings.progression.passiveLearning">Passive Learning</span>
                        </div>

                        <div class="passive-learning-controls">
                            <div class="setting-row-inline">
                                <div class="setting-info">
                                    <span class="setting-label" data-i18n="settings.progression.enablePassiveLearning">Enable Passive Learning</span>
                                    <span class="setting-desc" data-i18n="settings.progression.enablePassiveLearningDesc">Gain XP over time for your active spell</span>
                                </div>
                                <div class="inline-controls">
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="passiveLearningToggle">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                            </div>

                            <div class="setting-row-inline" style="margin-top: 6px;">
                                <div class="setting-info">
                                    <span class="setting-label">Applies To</span>
                                    <span class="setting-desc">Which spells gain passive XP</span>
                                </div>
                                <div class="inline-controls">
                                    <div id="passiveScopeToggle" class="segmented-toggle">
                                        <div class="seg-btn" data-value="all">All</div>
                                        <div class="seg-btn" data-value="root">Root</div>
                                        <div class="seg-btn active" data-value="novice">Novice</div>
                                    </div>
                                </div>
                            </div>

                            <div class="setting-row slider-row">
                                <div class="setting-info">
                                    <span class="setting-label" data-i18n="settings.progression.xpPerGameHour">XP per Game Hour</span>
                                    <span class="setting-desc" data-i18n="settings.progression.xpPerGameHourDesc">Passive XP gained each in-game hour</span>
                                </div>
                                <div class="slider-container">
                                    <input type="range" id="passiveXpPerHourSlider" min="1" max="50" value="5" step="1" class="setting-slider">
                                    <span id="passiveXpPerHourValue" class="slider-value">5</span>
                                </div>
                            </div>

                            <div class="settings-subsection" style="margin-top: 8px;">
                                <span class="subsection-title" style="font-size: 0.7em;" data-i18n="settings.progression.maxPassiveXpByTier">Max Passive XP % by Tier</span>
                            </div>
                            <div class="tier-xp-grid passive-tier-grid">
                                <div class="tier-xp-item">
                                    <label for="passiveMaxNovice" data-i18n="settings.progression.tierNovice">Novice</label>
                                    <input type="number" id="passiveMaxNovice" class="tier-xp-input" value="100" min="0" max="100">
                                    <span class="tier-xp-unit">%</span>
                                </div>
                                <div class="tier-xp-item">
                                    <label for="passiveMaxApprentice" data-i18n="settings.progression.tierApprentice">Apprentice</label>
                                    <input type="number" id="passiveMaxApprentice" class="tier-xp-input" value="75" min="0" max="100">
                                    <span class="tier-xp-unit">%</span>
                                </div>
                                <div class="tier-xp-item">
                                    <label for="passiveMaxAdept" data-i18n="settings.progression.tierAdept">Adept</label>
                                    <input type="number" id="passiveMaxAdept" class="tier-xp-input" value="50" min="0" max="100">
                                    <span class="tier-xp-unit">%</span>
                                </div>
                                <div class="tier-xp-item">
                                    <label for="passiveMaxExpert" data-i18n="settings.progression.tierExpert">Expert</label>
                                    <input type="number" id="passiveMaxExpert" class="tier-xp-input" value="25" min="0" max="100">
                                    <span class="tier-xp-unit">%</span>
                                </div>
                                <div class="tier-xp-item">
                                    <label for="passiveMaxMaster" data-i18n="settings.progression.tierMaster">Master</label>
                                    <input type="number" id="passiveMaxMaster" class="tier-xp-input" value="5" min="0" max="100">
                                    <span class="tier-xp-unit">%</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Progressive Reveal Thresholds -->
                        <div class="settings-subsection">
                            <span class="subsection-title" data-i18n="settings.progression.detailRevealThresholds">Detail Reveal Thresholds</span>
                        </div>
                        
                        <!-- Reveal Thresholds (compact 3-column grid) -->
                        <div class="slider-grid slider-grid-3">
                            <div class="slider-compact" data-i18n-title="settings.progression.revealNameTitle" title="Progress % to show spell name">
                                <span class="slider-compact-label" data-i18n="settings.progression.revealName">Reveal Name</span>
                                <div class="slider-compact-control">
                                    <input type="range" id="revealNameSlider" min="0" max="100" value="10" step="5" class="setting-slider">
                                    <span id="revealNameValue" class="slider-value">10%</span>
                                </div>
                            </div>
                            <div class="slider-compact" data-i18n-title="settings.progression.revealEffectsTitle" title="Progress % to show spell effects">
                                <span class="slider-compact-label" data-i18n="settings.progression.revealEffects">Reveal Effects</span>
                                <div class="slider-compact-control">
                                    <input type="range" id="revealEffectsSlider" min="0" max="100" value="25" step="5" class="setting-slider">
                                    <span id="revealEffectsValue" class="slider-value">25%</span>
                                </div>
                            </div>
                            <div class="slider-compact" data-i18n-title="settings.progression.revealDescTitle" title="Progress % to show description">
                                <span class="slider-compact-label" data-i18n="settings.progression.revealDescription">Reveal Description</span>
                                <div class="slider-compact-control">
                                    <input type="range" id="revealDescSlider" min="0" max="100" value="50" step="5" class="setting-slider">
                                    <span id="revealDescValue" class="slider-value">50%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Early Spell Learning (Progressive Effectiveness) -->
                <div class="settings-block" id="earlyLearningBlock">
                    <div class="settings-block-header">
                        <span class="settings-block-icon">*</span>
                        <span class="settings-block-title" data-i18n="settings.earlyLearning.title">Early Spell Learning</span>
                    </div>
                    <div class="settings-block-content">
                        <div class="settings-subsection">
                            <span class="subsection-title" data-i18n="settings.earlyLearning.subtitle">Progressive Effectiveness</span>
                            <span class="setting-desc" style="display: block; margin-bottom: 8px;" data-i18n="settings.earlyLearning.desc">Grant spells early at reduced power. Power increases as you practice.</span>
                        </div>
                        
                        <!-- Enable + Modify Display (paired toggles) -->
                        <div class="setting-pair">
                            <div class="setting-row">
                                <div class="setting-info">
                                    <span class="setting-label" data-i18n="settings.earlyLearning.enable">Enable Early Learning</span>
                                    <span class="setting-desc" data-i18n="settings.earlyLearning.enableDesc">Spells granted early but weakened</span>
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="earlyLearningEnabledToggle" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            <div class="setting-row">
                                <div class="setting-info">
                                    <span class="setting-label" data-i18n="settings.earlyLearning.modifyDisplay">Modify Game Display</span>
                                    <span class="setting-desc" data-i18n="settings.earlyLearning.modifyDisplayDesc">Show "(Learning - X%)" in menus</span>
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="modifyGameDisplayToggle" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                        
                        <!-- Unlock + Self-Cast Required (compact 2-column) -->
                        <div class="slider-grid slider-grid-2">
                            <div class="slider-compact" id="unlockThresholdRow" title="Progress % to grant spell (weakened)">
                                <span class="slider-compact-label" data-i18n="settings.earlyLearning.unlockThreshold">Unlock Threshold</span>
                                <div class="slider-compact-control">
                                    <input type="range" id="unlockThresholdSlider" min="10" max="50" value="25" step="5" class="setting-slider">
                                    <span id="unlockThresholdValue" class="slider-value">25%</span>
                                </div>
                            </div>
                            <div class="slider-compact" id="selfCastRequiredRow" title="Progress % after which you must cast the spell itself">
                                <span class="slider-compact-label" data-i18n="settings.earlyLearning.selfCastRequiredAt">Self-Cast Required At</span>
                                <div class="slider-compact-control">
                                    <input type="range" id="selfCastRequiredSlider" min="50" max="90" value="75" step="5" class="setting-slider">
                                    <span id="selfCastRequiredValue" class="slider-value">75%</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Self-Cast Bonus + Binary Threshold (compact 2-column) -->
                        <div class="slider-grid slider-grid-2">
                            <div class="slider-compact" id="selfCastMultiplierRow" title="XP multiplier when casting the learning target">
                                <span class="slider-compact-label" data-i18n="settings.earlyLearning.selfCastXpBonus">Self-Cast XP Bonus</span>
                                <div class="slider-compact-control">
                                    <input type="range" id="selfCastMultiplierSlider" min="100" max="300" value="150" step="25" class="setting-slider">
                                    <span id="selfCastMultiplierValue" class="slider-value">150%</span>
                                </div>
                            </div>
                            <div class="slider-compact" id="binaryThresholdRow" title="Progress % for on/off effects (Paralyze, etc.)">
                                <span class="slider-compact-label" data-i18n="settings.earlyLearning.binaryEffectThreshold">Binary Effect Threshold</span>
                                <div class="slider-compact-control">
                                    <input type="range" id="binaryThresholdSlider" min="60" max="100" value="80" step="5" class="setting-slider">
                                    <span id="binaryThresholdValue" class="slider-value">80%</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Weakened Spell Notifications (inline) -->
                        <div class="setting-row-inline">
                            <div class="setting-info">
                                <span class="setting-label" data-i18n="settings.earlyLearning.weakenedAlerts">Weakened Spell Alerts</span>
                            </div>
                            <div class="inline-controls">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="weakenedNotificationsToggle" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                                <div class="inline-slider-group" id="notificationIntervalRow">
                                    <span class="inline-slider-label" data-i18n="settings.earlyLearning.notificationEvery">Every</span>
                                    <input type="range" id="notificationIntervalSlider" min="5" max="60" value="10" class="setting-slider">
                                    <span class="slider-value" id="notificationIntervalValue">10s</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Power Steps Configuration -->
                        <div class="settings-subsection">
                            <span class="subsection-title" data-i18n="settings.earlyLearning.powerStepConfig">Power Step Configuration</span>
                        </div>
                        <p class="setting-note" data-i18n="settings.earlyLearning.powerStepNote">Configure how spell power increases with XP progress. Each step defines an XP threshold and power level.</p>
                        
                        <div id="powerStepsContainer" class="power-steps-container">
                            <!-- Dynamically populated -->
                        </div>
                        
                        <div class="setting-row power-steps-actions">
                            <button id="resetPowerStepsBtn" class="btn btn-secondary btn-small">
                                <span class="btn-icon">[R]</span> <span data-i18n="settings.earlyLearning.resetDefaults">Reset to Defaults</span>
                            </button>
                        </div>

                        <!-- Modded XP Sources (populated dynamically when external mods register) -->
                        <div id="moddedXPSourcesSection" class="settings-subsection" style="display:none;">
                            <span class="subsection-title">Modded XP Sources</span>
                            <p class="setting-note">External mods that grant XP. Each source has its own multiplier and cap, and is still affected by the Overall XP Multiplier.</p>
                            <div id="moddedXPSourcesList"></div>
                        </div>
                    </div>
                </div>
                </div><!-- /settings-split ROW 2 -->

                <!-- ===== ROW 3: Spell Tome + Developer & Debug ===== -->
                <div class="settings-split">
                <div class="settings-block" id="spellTomeLearningBlock">
                    <div class="settings-block-header">
                        <span class="settings-block-icon">[i]</span>
                        <span class="settings-block-title" data-i18n="settings.tomeLearning.title">Spell Tome Learning</span>
                    </div>
                    <div class="settings-block-content">
                        <div class="settings-subsection">
                            <span class="subsection-title" data-i18n="settings.tomeLearning.subtitle">Tome Behavior</span>
                            <span class="setting-desc" style="display: block; margin-bottom: 8px;" data-i18n="settings.tomeLearning.desc">Configure how spell tomes work with the progression system.</span>
                        </div>
                        
                        <div class="setting-row">
                            <div class="setting-info">
                                <span class="setting-label" data-i18n="settings.tomeLearning.useProgression">Use Progression System</span>
                                <span class="setting-desc" data-i18n="settings.tomeLearning.useProgressionDesc">XP + weakened spells instead of instant learning</span>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="useProgressionSystemToggle" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        
                        <p id="tomeLearningModeDesc" class="setting-note" style="margin: 8px 0 16px 0;">
                            Reading tomes grants XP and gives early access to weakened spells. Keep tomes to practice!
                        </p>
                        
                        <!-- XP Grant + Inventory Boost side by side -->
                        <div class="setting-pair">
                            <div class="setting-row slider-row" id="tomeXpGrantRow">
                                <div class="setting-info">
                                    <span class="setting-label" data-i18n="settings.tomeLearning.xpGrantOnRead">XP Grant on Read</span>
                                    <span class="setting-desc" data-i18n="settings.tomeLearning.xpGrantOnReadDesc">% of required XP from reading tome</span>
                                </div>
                                <div class="slider-container">
                                    <input type="range" id="tomeXpGrantSlider" min="10" max="50" value="25" step="5" class="setting-slider">
                                    <span id="tomeXpGrantValue" class="slider-value">25%</span>
                                </div>
                            </div>
                            <div class="setting-row-inline">
                                <div class="setting-info">
                                    <span class="setting-label" data-i18n="settings.tomeLearning.inventoryBoost">Inventory Boost</span>
                                    <span class="setting-desc" data-i18n="settings.tomeLearning.inventoryBoostDesc">Bonus XP while carrying tome</span>
                                </div>
                                <div class="inline-controls">
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="tomeInventoryBoostToggle" checked>
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <div class="inline-slider-group" id="tomeInventoryBoostRow">
                                        <input type="range" id="tomeInventoryBoostSlider" min="10" max="100" value="25" step="5" class="setting-slider">
                                        <span id="tomeInventoryBoostValue" class="slider-value">+25%</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="settings-subsection" style="margin-top: 12px;">
                            <span class="subsection-title" data-i18n="settings.tomeLearning.learningReqs">Learning Requirements</span>
                        </div>
                        
                        <!-- Requirements (triple row) -->
                        <div class="setting-triple">
                            <div class="setting-row">
                                <div class="setting-info">
                                    <span class="setting-label" data-i18n="settings.tomeLearning.requirePrereqs">Require Prereqs</span>
                                    <span class="setting-desc" data-i18n="settings.tomeLearning.requirePrereqsDesc">Master parent spells first</span>
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="tomeRequirePrereqsToggle" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            <div class="setting-row" id="tomeRequireAllPrereqsRow">
                                <div class="setting-info">
                                    <span class="setting-label" data-i18n="settings.tomeLearning.requireAll">Require ALL</span>
                                    <span class="setting-desc" data-i18n="settings.tomeLearning.requireAllDesc">All parents, not just one</span>
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="tomeRequireAllPrereqsToggle" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            <div class="setting-row">
                                <div class="setting-info">
                                    <span class="setting-label" data-i18n="settings.tomeLearning.requireSkill">Require Skill</span>
                                    <span class="setting-desc" data-i18n="settings.tomeLearning.requireSkillDesc">Meet minimum skill level</span>
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="tomeRequireSkillLevelToggle">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Developer & Debug Settings (right column of split) -->
                <div class="settings-block dev-debug-block">
                    <div class="settings-block-header">
                        <span class="settings-block-icon">[D]</span>
                        <span class="settings-block-title" data-i18n="settings.devDebug.title">Developer & Debug</span>
                        <span class="cheat-warning" data-i18n="settings.devDebug.advancedOptions">Advanced options</span>
                    </div>
                    <div class="settings-block-content">
                        <!-- Developer Mode -->
                        <div class="setting-row">
                            <div class="setting-info">
                                <span class="setting-label" data-i18n="settings.devDebug.developerMode">Developer Mode</span>
                                <span class="setting-desc" data-i18n="settings.devDebug.developerModeDesc">Show advanced generation options</span>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="developerModeToggle">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        
                        <!-- Cheat Mode -->
                        <div class="setting-row">
                            <div class="setting-info">
                                <span class="setting-label" data-i18n="settings.devDebug.cheatMode">Cheat Mode</span>
                                <span class="setting-desc" data-i18n="settings.devDebug.cheatModeDesc">Full control over all spells and progression</span>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="cheatModeToggle">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <div id="cheatModeInfo" class="cheat-info hidden">
                            <p data-i18n-html="settings.devDebug.cheatModeActive">(!) <strong>Cheat mode active!</strong></p>
                            <ul>
                                <li data-i18n="settings.devDebug.cheatInfo.seeAll">See all spell names and details (even locked)</li>
                                <li data-i18n="settings.devDebug.cheatInfo.clickUnlock">Click any node to unlock instantly</li>
                                <li data-i18n="settings.devDebug.cheatInfo.editXp">Edit XP progress directly (current/required)</li>
                            </ul>
                        </div>
                        
                        <!-- Debug Options (shown when developer mode is on) -->
                        <div id="debugOptionsSection" class="dev-only-settings hidden">
                            <div class="settings-subsection">
                                <span class="subsection-title" data-i18n="settings.devDebug.debugOptions">Debug Options</span>
                            </div>
                            <div class="setting-row">
                                <div class="setting-info">
                                    <span class="setting-label" data-i18n="settings.devDebug.verboseLogging">Verbose Logging</span>
                                    <span class="setting-desc" data-i18n="settings.devDebug.verboseLoggingDesc">Extra console logging for troubleshooting</span>
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="verboseLogToggle">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            <div class="setting-row">
                                <div class="setting-info">
                                    <span class="setting-label" data-i18n="settings.devDebug.showDebugGrid">Show Debug Grid</span>
                                    <span class="setting-desc" data-i18n="settings.devDebug.showDebugGridDesc">Show grid candidate positions for debugging spacing</span>
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="debugGridToggle">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                </div><!-- /settings-split ROW 3: Spell Tome + Developer -->

                <!-- Tree Generation Settings - Developer only (related to LLM auto features) -->
                <div class="settings-block dev-only">
                    <div class="settings-block-header">
                        <span class="settings-block-icon">[T]</span>
                        <span class="settings-block-title" data-i18n="settings.treeGen.title">Tree Generation</span>
                    </div>
                    <div class="settings-block-content">
                        <div class="setting-hint" style="font-size: 0.8em; color: var(--text-muted); margin-bottom: 12px; padding: 8px; background: rgba(0,0,0,0.2); border-radius: 4px;">
                            These settings control how spell prerequisites are generated and validated.
                            <br><strong>LLM Prereqs</strong> = AI designs multi-prereq during generation
                            <br><strong>Procedural Injection</strong> = adds extra prereqs AFTER generation
                        </div>
                        
                        <!-- LLM Generation Settings -->
                        <div class="settings-subsection" style="margin-left: 8px; padding-left: 8px; border-left: 2px solid var(--accent-blue);">
                            <div class="settings-sublabel" style="font-size: 0.75em; color: var(--accent-blue); margin-bottom: 8px;">
                                DURING LLM GENERATION
                            </div>
                            <div class="setting-row">
                                <div class="setting-info">
                                    <span class="setting-label" data-i18n="settings.treeGen.allowLlmMultiple">Allow LLM Multiple Prereqs</span>
                                    <span class="setting-desc" data-i18n="settings.treeGen.allowLlmMultipleDesc">AI can design spells that require 2-3 prerequisites</span>
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="allowLLMMultiplePrereqsToggle" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            <div class="setting-row">
                                <div class="setting-info">
                                    <span class="setting-label" data-i18n="settings.treeGen.llmSelfCorrection">LLM Self-Correction</span>
                                    <span class="setting-desc" data-i18n="settings.treeGen.llmSelfCorrectionDesc">AI fixes its own mistakes (uses more tokens but better results)</span>
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="llmSelfCorrectionToggle" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            <div class="setting-row" id="llmCorrectionLoopsRow">
                                <div class="setting-info">
                                    <span class="setting-label" data-i18n="settings.treeGen.maxCorrectionLoops">Max Correction Loops</span>
                                    <span class="setting-desc" data-i18n="settings.treeGen.maxCorrectionLoopsDesc">How many times AI can retry before auto-fix</span>
                                </div>
                                <div class="setting-control">
                                    <input type="range" id="llmCorrectionLoopsSlider" min="1" max="10" value="5" class="setting-slider">
                                    <span id="llmCorrectionLoopsValue">5</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Validation Settings -->
                        <div class="settings-subsection" style="margin-left: 8px; padding-left: 8px; border-left: 2px solid var(--accent-orange); margin-top: 12px;">
                            <div class="settings-sublabel" style="font-size: 0.75em; color: var(--accent-orange); margin-bottom: 8px;">
                                VALIDATION & AUTO-FIX
                            </div>
                            <div class="setting-row">
                                <div class="setting-info">
                                    <span class="setting-label" data-i18n="settings.treeGen.aggressivePath">Aggressive Path Validation</span>
                                    <span class="setting-desc" data-i18n="settings.treeGen.aggressivePathDesc">When ON: replaces broken prereqs. When OFF: more lenient</span>
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="aggressivePathValidationToggle" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            
                            <!-- Retry Specific School -->
                            <div class="setting-row" id="retrySchoolRow" style="margin-top: 12px; display: none;">
                                <div class="setting-info">
                                    <span class="setting-label" data-i18n="settings.treeGen.retrySchool">Retry Problem School</span>
                                    <span class="setting-desc" data-i18n="settings.treeGen.retrySchoolDesc">Regenerate tree for schools with unreachable nodes</span>
                                </div>
                                <div class="setting-control" style="display: flex; gap: 8px; align-items: center;">
                                    <select id="retrySchoolSelect" class="setting-select" style="min-width: 120px;">
                                        <option value="" data-i18n="settings.treeGen.selectSchool">Select school...</option>
                                    </select>
                                    <button id="retrySchoolBtn" class="action-btn" style="padding: 4px 12px; font-size: 0.85em;">
                                        <span class="btn-icon">[R]</span> Retry
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                    </div>
                </div>

                <!-- Save/Reset - Sticky at bottom of settings panel -->
                <div class="settings-actions-sticky">
                    <button id="saveSettingsBtn" class="btn btn-primary">
                        <span class="btn-icon">[S]</span> <span data-i18n="settings.actions.saveSettings">Save Settings</span>
                    </button>
                    <button id="resetSettingsBtn" class="btn btn-secondary">
                        <span class="btn-icon">[R]</span> <span data-i18n="settings.actions.resetDefaults">Reset to Defaults</span>
                    </button>
                </div>
            </div>

        </div>

        <!-- Resize Handle -->
        <div class="resize-handle" id="resizeHandle"></div>
    </div>

    <!-- Import Modal -->
    <div id="import-modal" class="modal modal-fullpanel hidden">
        <div class="modal-backdrop"></div>
        <div class="modal-content modal-content-full">
            <div class="modal-header">
                <h3 data-i18n="modals.importTree.title">Spell Tree JSON</h3>
                <button class="modal-close" id="modal-close-btn">×</button>
            </div>
            <div class="modal-body modal-body-full">
                <textarea id="import-textarea" class="json-editor" spellcheck="false" placeholder='{"version": "1.0", "schools": {...}}'></textarea>
                <div id="import-error" class="error-box hidden"></div>
            </div>
            <div class="modal-footer">
                <button id="paste-tree-btn" class="btn btn-sm" style="margin-right:auto;">Paste</button>
                <button id="import-cancel" class="btn btn-sm">Cancel</button>
                <button id="import-confirm" class="btn btn-success" data-i18n="modals.importTree.save">Save</button>
            </div>
        </div>
    </div>

    <!-- Spawn Spell Modal (Edit Mode) -->
    <div id="spawn-spell-modal" class="modal hidden">
        <div class="modal-backdrop"></div>
        <div class="modal-content spawn-modal">
            <div class="modal-header">
                <h3 data-i18n="modals.spawnSpell.title">Spawn Spell Node</h3>
                <button class="modal-close" id="spawn-modal-close">×</button>
            </div>
            <div class="modal-body">
                <input type="text" id="spawn-search" class="spawn-search" placeholder="Search spells..." data-i18n-placeholder="modals.spawnSpell.searchPlaceholder" autofocus>
                <div id="spawn-spell-list" class="spawn-spell-list">
                    <div class="spawn-loading" data-i18n="modals.spawnSpell.loading">Loading spells...</div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="spawn-cancel" class="btn btn-secondary" data-i18n="modals.spawnSpell.cancel">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Find Spell Modal (Spell Tree Search) -->
    <div id="find-spell-modal" class="modal hidden">
        <div class="modal-backdrop"></div>
        <div class="modal-content find-spell-modal">
            <div class="modal-header">
                <h3>Find Spell</h3>
                <span class="find-spell-hint">F</span>
                <button class="modal-close" id="find-spell-close">&times;</button>
            </div>
            <div class="modal-body">
                <input type="text" id="find-spell-search" class="spawn-search" placeholder="Search spells on tree..." autofocus>
                <div id="find-spell-list" class="spawn-spell-list">
                </div>
            </div>
        </div>
    </div>

    <!-- Preset Name Prompt Modal -->
    <div id="preset-name-modal" class="modal hidden">
        <div class="modal-backdrop"></div>
        <div class="modal-content" style="width: 320px;">
            <div class="modal-header">
                <h3 id="preset-name-title" data-i18n="modals.presetName.title">Save Preset</h3>
                <button class="modal-close" id="preset-name-close">&times;</button>
            </div>
            <div class="modal-body" style="padding: 12px 16px;">
                <input type="text" id="preset-name-input" class="spawn-search" placeholder="Enter preset name..." data-i18n-placeholder="modals.presetName.placeholder" style="width: 100%; margin-bottom: 0;">
            </div>
            <div class="modal-footer">
                <button id="preset-name-cancel" class="btn btn-secondary" data-i18n="modals.presetName.cancel">Cancel</button>
                <button id="preset-name-confirm" class="btn btn-primary" data-i18n="modals.presetName.save">Save</button>
            </div>
        </div>
    </div>

    <!-- Blacklist Spell Modal -->
    <div id="blacklist-modal" class="modal hidden">
        <div class="modal-backdrop"></div>
        <div class="modal-content blacklist-modal">
            <div class="modal-header">
                <h3 data-i18n="modals.blacklist.title">Spell Blacklist</h3>
                <button class="modal-close" id="blacklist-modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="blacklist-search-section">
                    <input type="text" id="blacklist-search" class="spawn-search" placeholder="Search spells to blacklist..." data-i18n-placeholder="modals.blacklist.searchPlaceholder">
                    <div id="blacklist-search-results" class="spawn-spell-list blacklist-dropdown hidden"></div>
                </div>
                <div class="blacklist-divider"></div>
                <div class="blacklist-list-header">
                    <span data-i18n="modals.blacklist.listHeader">Blacklisted Spells</span>
                    <span id="blacklist-count" class="blacklist-count">0</span>
                </div>
                <div id="blacklist-entries" class="blacklist-entries">
                    <div class="blacklist-empty" data-i18n="modals.blacklist.empty">No spells blacklisted</div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="blacklist-clear-all" class="btn btn-secondary" data-i18n="modals.blacklist.clearAll">Clear All</button>
                <button id="blacklist-done" class="btn btn-primary" data-i18n="modals.blacklist.done">Done</button>
            </div>
        </div>
    </div>

    <!-- Whitelist Plugin Modal -->
    <div id="whitelist-modal" class="modal hidden">
        <div class="modal-backdrop"></div>
        <div class="modal-content whitelist-modal">
            <div class="modal-header">
                <h3 data-i18n="modals.whitelist.title">Plugin Whitelist</h3>
                <button class="modal-close" id="whitelist-modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="whitelist-info">
                    <span class="whitelist-info-text" data-i18n="modals.whitelist.info">Select plugins to include in spell scanning. If none selected, all plugins are scanned.</span>
                </div>
                <div class="whitelist-search-section">
                    <input type="text" id="whitelist-search" class="spawn-search" placeholder="Filter plugins..." data-i18n-placeholder="modals.whitelist.filterPlaceholder">
                </div>
                <div class="whitelist-divider"></div>
                <div class="whitelist-section">
                    <div class="whitelist-section-header">
                        <span data-i18n="modals.whitelist.baseGame">Base Game</span>
                        <span id="whitelist-base-count" class="whitelist-count">0</span>
                    </div>
                    <div id="whitelist-base-entries" class="whitelist-entries whitelist-base">
                        <!-- Base game plugins rendered here -->
                    </div>
                </div>
                <div class="whitelist-divider"></div>
                <div class="whitelist-section">
                    <div class="whitelist-section-header">
                        <span data-i18n="modals.whitelist.modPlugins">Mod Plugins</span>
                        <span id="whitelist-mod-count" class="whitelist-count">0</span>
                    </div>
                    <div id="whitelist-mod-entries" class="whitelist-entries whitelist-mods">
                        <div class="whitelist-empty" data-i18n="modals.whitelist.emptyMods">Scan spells first to see plugins</div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="whitelist-all" class="btn btn-secondary" data-i18n="modals.whitelist.all">All</button>
                <button id="whitelist-none" class="btn btn-secondary" data-i18n="modals.whitelist.none">None</button>
                <button id="whitelist-base-only" class="btn btn-secondary" data-i18n="modals.whitelist.baseOnly">Base Only</button>
                <button id="whitelist-done" class="btn btn-primary" data-i18n="modals.whitelist.done">Done</button>
            </div>
        </div>
    </div>

    <!-- Build Progress Modal -->
    <div id="build-progress-modal" class="modal hidden">
        <div class="modal-backdrop"></div>
        <div class="modal-content build-progress-modal">
            <div class="modal-header">
                <h3 id="build-progress-title" data-i18n="modals.buildProgress.title">Building Spell Tree</h3>
            </div>
            <div class="modal-body">
                <div class="build-stages" id="build-stages">
                    <div class="build-stage" data-stage="tree" id="build-stage-tree">
                        <span class="build-stage-icon" id="build-stage-tree-icon">&#9711;</span>
                        <span class="build-stage-label" data-i18n="modals.buildProgress.stageTree">Analyzing &amp; Building Spell Tree</span>
                        <span class="build-stage-detail" id="build-stage-tree-detail"></span>
                    </div>
                    <div class="build-stage" data-stage="prereqs" id="build-stage-prereqs">
                        <span class="build-stage-icon" id="build-stage-prereqs-icon">&#9711;</span>
                        <span class="build-stage-label" data-i18n="modals.buildProgress.stagePrereqs">Running Pre Req Master</span>
                        <span class="build-stage-detail" id="build-stage-prereqs-detail"></span>
                    </div>
                    <div class="build-stage" data-stage="finalize" id="build-stage-finalize">
                        <span class="build-stage-icon" id="build-stage-finalize-icon">&#9711;</span>
                        <span class="build-stage-label" data-i18n="modals.buildProgress.stageFinalize">Finalizing Layout</span>
                        <span class="build-stage-detail" id="build-stage-finalize-detail"></span>
                    </div>
                </div>
                <div class="build-progress-bar">
                    <div class="build-progress-fill" id="build-progress-fill"></div>
                </div>
                <div class="build-progress-status" id="build-progress-status" data-i18n="modals.buildProgress.preparing">Preparing...</div>
            </div>
            <div class="modal-footer">
                <button id="build-progress-done-btn" class="btn btn-primary hidden" onclick="BuildProgress.close()" data-i18n="modals.buildProgress.done">Done</button>
            </div>
        </div>
    </div>

    <!-- Tooltip -->
    <div id="tooltip" class="tooltip hidden">
        <div class="tooltip-name"></div>
        <div class="tooltip-info"></div>
        <div class="tooltip-state"></div>
    </div>

    <!-- 
    MODULAR JavaScript Loading
    ==========================
    Modules are loaded first, then script.js for remaining application logic.
    All functionality is preserved, just split for LLM maintainability.
    -->
    
    <!-- 0. i18n Translation Engine (must load first) -->
    <script src="lang/en.js"></script>
    <script src="lang/locale.js"></script>
    <script src="modules/i18n.js"></script>
    <script>initI18n(window._i18nLocale || 'en');</script>

    <!-- 1. Constants and Configuration -->
    <script src="modules/constants.js"></script>
    <script src="modules/state.js"></script>
    <script src="modules/config.js"></script>

    <!-- 1.5. Unified Core Modules (new) -->
    <script src="modules/edgeScoring.js"></script>
    <script src="modules/shapeProfiles.js"></script>
    <script src="modules/layoutEngine.js"></script>

    <!-- 2. Core Utilities -->
    <script src="modules/spellCache.js"></script>
    <script src="modules/colorUtils.js"></script>
    <script src="modules/uiHelpers.js"></script>
    
    <!-- 3. DSL and Parsers -->
    <script src="modules/growthDSL.js"></script>
    <script src="modules/treeParser.js"></script>
    
    <!-- 4. Renderer -->
    <script src="modules/wheelRenderer.js"></script>
    <script src="modules/starfield.js"></script>
    <script src="modules/globe3D.js"></script>
    <script src="modules/canvasRendererV2.js"></script>
    <script src="modules/trustedRenderer.js"></script>
    <script src="modules/editMode.js"></script>
    <!-- Note: WebGL is NOT supported in Ultralight/PrismaUI - Canvas 2D is used for large trees -->
    <!-- Old renderer: canvasRenderer.js (depends on TREE_CONFIG/WheelRenderer/GRID_CONFIG) -->
    <!-- SpellTreeRenderer available at modules/tierVisuals.js + modules/spellTreeRenderer.js (not loaded) -->
    
    <!-- 5. UI Panels and Features -->
    <script src="modules/colorPicker.js"></script>
    <script src="modules/settingsPanel.js"></script>
    <script src="modules/treeViewerUI.js"></script>
    <script src="modules/progressionUI.js"></script>
    <script src="modules/settingsPresets.js"></script>
    <script src="modules/scannerPresets.js"></script>
    <script src="modules/easyMode.js"></script>
    <script src="modules/llmApiSettings.js"></script>
    <script src="modules/buttonHandlers.js"></script>
    
    <!-- 5b. Tree Preview -->
    <script src="modules/treePreviewUtils.js"></script>
    <script src="modules/sunGridLinear.js"></script>
    <script src="modules/sunGridEqualArea.js"></script>
    <script src="modules/sunGridFibonacci.js"></script>
    <script src="modules/sunGridSquare.js"></script>
    <script src="modules/treePreviewSun.js"></script>
    <script src="modules/treePreviewFlat.js"></script>
    <script src="modules/treePreview.js"></script>

    <!-- 5b2. Core Settings -->
    <script src="modules/treeCore.js"></script>

    <!-- 5c. Tree Growth -->
    <script src="modules/classic/classicRenderer.js"></script>
    <script src="modules/classic/classicThemeEngine.js"></script>
    <script src="modules/classic/classicLayout.js"></script>
    <script src="modules/classic/classicSettings.js"></script>
    <script src="modules/classic/classicMain.js"></script>
    <script src="modules/tree/treeRenderer.js"></script>
    <script src="modules/tree/treeTrunk.js"></script>
    <script src="modules/tree/treeSettings.js"></script>
    <script src="modules/treeGrowthTree.js"></script>
    <!-- Graph Growth module -->
    <script src="modules/graph/graphRenderer.js"></script>
    <script src="modules/graph/graphLayout.js"></script>
    <script src="modules/graph/graphSettings.js"></script>
    <script src="modules/graph/graphMain.js"></script>
    <!-- Oracle Growth module -->
    <script src="modules/oracle/oracleRenderer.js"></script>
    <script src="modules/oracle/oracleLayout.js"></script>
    <script src="modules/oracle/oracleSettings.js"></script>
    <script src="modules/oracle/oracleMain.js"></script>
    <!-- Thematic Growth module -->
    <script src="modules/thematic/thematicRenderer.js"></script>
    <script src="modules/thematic/thematicLayout.js"></script>
    <script src="modules/thematic/thematicSettings.js"></script>
    <script src="modules/thematic/thematicMain.js"></script>
    <script src="modules/treeGrowth.js"></script>

    <!-- 6. Integrations and Callbacks -->
    <script src="modules/cppCallbacks.js"></script>
    <script src="modules/buildProgress.js"></script>
    <script src="modules/llmIntegration.js"></script>
    <script src="modules/proceduralTreeBuilder.js"></script>
    
    <!-- 6.5. Visual-First Tree Builder -->
    <script src="modules/layoutGenerator.js"></script>

    <script src="modules/growthBehaviors.js"></script>
    <script src="modules/visualFirstBuilder.js"></script>
    <script src="modules/llmTreeFeatures.js"></script>
    <script src="modules/settingsAwareTreeBuilder.js"></script>

    <script src="modules/generationModeUI.js"></script>

    <!-- 6.6. Pre Req Master -->
    <script src="modules/prereqMaster.js"></script>

    <!-- 6.7. Tree Animation (build replay) -->
    <script src="modules/treeAnimation.js"></script>

    <!-- 7. Main Application (init, tabs, dragging, early learning settings) -->
    <script src="script.js"></script>

    <!-- 8. Auto-Test Module -->
    <script src="modules/autoTest.js"></script>

    <!-- 8.5. Unification Test Module -->
    <script src="modules/unificationTest.js"></script>

    <!-- 9. Main Entry Point (initialization, module verification) -->
    <script src="modules/main.js"></script>
</body>
</html>
