<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Heart of Magic — Dev Harness</title>
    <style>
        /* Harness chrome - toolbar at top */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: #1a1a2e; font-family: 'Segoe UI', sans-serif; overflow: hidden; }

        #harness-toolbar {
            position: fixed; top: 0; left: 0; right: 0; z-index: 10000;
            background: #0d1117; border-bottom: 1px solid #30363d;
            display: flex; align-items: center; gap: 8px;
            padding: 4px 12px; height: 36px; font-size: 13px; color: #c9d1d9;
        }
        #harness-toolbar .toolbar-title { font-weight: 600; color: #58a6ff; margin-right: 12px; }
        #harness-toolbar button {
            background: #21262d; border: 1px solid #30363d; color: #c9d1d9;
            padding: 3px 10px; border-radius: 4px; cursor: pointer; font-size: 12px;
        }
        #harness-toolbar button:hover { background: #30363d; border-color: #58a6ff; }
        #harness-toolbar button.active { background: #388bfd33; border-color: #58a6ff; color: #58a6ff; }
        #harness-toolbar .separator { width: 1px; height: 20px; background: #30363d; }
        #harness-toolbar .status { color: #8b949e; font-size: 11px; margin-left: auto; }
        #harness-toolbar .status .ok { color: #3fb950; }
        #harness-toolbar .status .warn { color: #d29922; }

        /* Game viewport simulation */
        #game-viewport {
            position: fixed; top: 36px; left: 0; right: 0; bottom: 28px;
            background: #0a0a14;
            display: flex; align-items: center; justify-content: center;
        }
        #game-viewport .game-bg-text {
            color: rgba(255,255,255,0.05); font-size: 48px; font-weight: bold;
            user-select: none; pointer-events: none;
        }

        /* Panel container - the actual PrismaUI panel lives here */
        #panel-host {
            position: fixed; top: 36px; left: 0; right: 0; bottom: 28px;
            z-index: 100; pointer-events: none;
        }
        #panel-host > * { pointer-events: auto; }

        /* Status bar at bottom */
        #harness-status {
            position: fixed; bottom: 0; left: 0; right: 0; z-index: 10000;
            background: #0d1117; border-top: 1px solid #30363d;
            display: flex; align-items: center; gap: 16px;
            padding: 4px 12px; height: 28px; font-size: 11px; color: #8b949e;
        }
        #harness-status .log-entry { display: flex; gap: 4px; }
        #harness-status .log-entry .method { color: #58a6ff; }
        #harness-status .log-entry .data { color: #8b949e; max-width: 400px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

        /* C++ call log panel */
        #cpp-log {
            position: fixed; top: 36px; right: 0; width: 360px; bottom: 28px;
            background: rgba(13,17,23,0.95); border-left: 1px solid #30363d;
            z-index: 9999; display: none; overflow-y: auto; font-size: 11px;
            font-family: 'Cascadia Code', 'Consolas', monospace;
        }
        #cpp-log.visible { display: block; }
        #cpp-log .log-header {
            position: sticky; top: 0; background: #161b22;
            padding: 8px; border-bottom: 1px solid #30363d;
            display: flex; justify-content: space-between; align-items: center;
        }
        #cpp-log .log-header span { color: #c9d1d9; font-weight: 600; }
        #cpp-log .log-body { padding: 4px; }
        #cpp-log .log-item {
            padding: 3px 6px; border-bottom: 1px solid #21262d;
            display: flex; gap: 6px; word-break: break-all;
        }
        #cpp-log .log-item .dir { width: 16px; text-align: center; flex-shrink: 0; }
        #cpp-log .log-item .dir.out { color: #58a6ff; }
        #cpp-log .log-item .dir.in { color: #3fb950; }
        #cpp-log .log-item .method { color: #d2a8ff; flex-shrink: 0; }
        #cpp-log .log-item .payload { color: #8b949e; }
    </style>

    <!-- MOCK C++ BRIDGE - Must be BEFORE all module scripts -->
    <script src="dev-harness-bridge.js"></script>

    <!-- Load the real Skyrim CSS theme -->
    <link rel="stylesheet" href="styles-skyrim.css">
    <script>window.AUTO_TEST_BUILD = false;</script>
</head>
<body>
    <!-- Harness Toolbar -->
    <div id="harness-toolbar">
        <span class="toolbar-title">HoM Dev Harness</span>
        <button id="btn-toggle-panel" class="active">Panel</button>
        <button id="btn-scan-mock">Mock Scan</button>
        <button id="btn-load-test-data">Load Test Data</button>
        <button id="btn-build-tree">Build Tree</button>
        <span class="separator"></span>
        <button id="btn-toggle-log">C++ Log</button>
        <button id="btn-clear-log">Clear</button>
        <span class="status">
            Bridge: <span class="ok">MOCK</span> |
            Spells: <span id="status-spell-count">0</span> |
            Schools: <span id="status-school-count">0</span>
        </span>
    </div>

    <!-- Simulated game background -->
    <div id="game-viewport">
        <span class="game-bg-text">SKYRIM GAME VIEWPORT</span>
    </div>

    <!-- Panel Host - the actual UI panel renders here -->
    <div id="panel-host">
        <!-- Focus overlay -->
        <div id="focusOverlay" class="focus-overlay"></div>

        <div id="spellPanel" class="spell-panel">
            <!-- Draggable Header -->
            <div class="panel-header" id="panelHeader">
                <div class="header-left">
                    <span class="panel-title">HEART OF MAGIC</span>
                    <span class="version-tag">v2.0.0-dev</span>
                </div>
                <div class="header-right">
                    <button class="header-btn header-btn-wide" id="tabSpellScan" data-tab="spellScan" title="Spell Scanner">Scan</button>
                    <button class="header-btn header-btn-wide" id="tabSettings" data-tab="settings" title="Settings">Settings</button>
                    <button class="header-btn" id="fullscreenBtn" title="Toggle Fullscreen">[ ]</button>
                    <button class="header-btn" id="closeBtn" title="Close (Esc/Tab)">X</button>
                </div>
            </div>

            <!-- Main Content -->
            <div class="panel-content" id="panelContent">

                <!-- PANEL: Spell Scan (toggled from header) -->
                <div class="tab-content" id="contentSpellScan">
                    <!-- Mode Toggle Bar -->
                    <div class="scanner-mode-bar">
                        <button class="scanner-mode-btn active" data-scanner-mode="easy">EASY</button>
                        <button class="scanner-mode-btn" data-scanner-mode="complex">COMPLEX</button>
                    </div>

                    <!-- Shared Status Bar -->
                    <div class="scan-status-bar" id="scanStatusBar">
                        <span id="scanStatusText">Ready to scan</span>
                    </div>

                    <!-- EASY MODE -->
                    <!-- ============================================================ -->
                    <!-- SHARED: Scan Actions + Results/Filters (visible in both modes) -->
                    <!-- ============================================================ -->
                    <div class="scan-actions-sticky">
                        <button id="scanBtn" class="btn btn-primary">
                            <span class="btn-icon">[*]</span> Scan Spells
                        </button>
                        <button id="saveBtn" class="btn btn-secondary" disabled>
                            <span class="btn-icon">[S]</span> Export Scan
                        </button>
                    </div>

                    <!-- Section 1: Scan Results + Filters (split layout) -->
                    <div class="scan-section scan-split" id="scanResultsSection">
                        <!-- Left: Scan Stats -->
                        <div class="scan-split-left">
                            <div class="scan-stats-header">Scan Results</div>
                            <div class="scan-stats-grid" id="scanStatsGrid">
                                <div class="scan-stat">
                                    <span class="scan-stat-value" id="statTotalSpells">--</span>
                                    <span class="scan-stat-label">Total Spells</span>
                                </div>
                                <div class="scan-stat">
                                    <span class="scan-stat-value" id="statTotalMods">--</span>
                                    <span class="scan-stat-label">Mods</span>
                                </div>
                                <div class="scan-stat scan-stat-primed">
                                    <span class="scan-stat-value" id="statPrimedSpells">--</span>
                                    <span class="scan-stat-label">Primed</span>
                                </div>
                            </div>
                            <div class="scan-school-breakdown" id="scanSchoolBreakdown">
                                <!-- Populated after scan -->
                            </div>
                        </div>

                        <!-- Right: Filters -->
                        <div class="scan-split-right">
                            <div class="scan-stats-header">Filters</div>
                            <div class="scan-filter-controls">
                                <button id="blacklistBtn" class="btn btn-secondary btn-filter" disabled>
                                    <span class="btn-icon">[-]</span> Blacklist
                                </button>
                                <button id="whitelistBtn" class="btn btn-secondary btn-filter" disabled>
                                    <span class="btn-icon">[+]</span> Whitelist
                                </button>
                                <div class="scan-filter-toggle">
                                    <label class="toggle-switch toggle-sm">
                                        <input type="checkbox" id="scanModeTomes">
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <span class="scan-filter-label">Tomes only</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ============================================================ -->
                    <!-- EASY MODE -->
                    <!-- ============================================================ -->
                    <div class="scanner-mode-content" id="scannerEasyContent">
                        <div class="easy-presets-section">
                            <div class="easy-presets-label">Choose a Preset</div>
                            <div class="easy-preset-chips" id="easyPresetChips"></div>
                        </div>
                        <div class="easy-actions-section">
                            <button id="easyBuildBtn" class="btn btn-success easy-action-btn" disabled>
                                <span class="btn-icon">[B]</span> Build Tree
                            </button>
                            <button id="easyApplyBtn" class="btn btn-primary easy-action-btn" disabled>
                                <span class="btn-icon">[A]</span> Apply Tree
                            </button>
                            <button id="easyClearBtn" class="btn btn-danger easy-action-btn" disabled>
                                <span class="btn-icon">[X]</span> Clear Tree
                            </button>
                            <span class="easy-status-wrap">Status: <span id="easyStatus">Waiting for scan...</span></span>
                        </div>
                        <div class="easy-preview-placeholder" id="easyPreviewPlaceholder">
                            <!-- PRM preview canvas is moved here when Easy mode is active -->
                        </div>
                    </div>

                    <!-- COMPLEX MODE (all existing scanner content) -->
                    <div class="scanner-mode-content" id="scannerComplexContent" style="display:none;">

                    <!-- Section 2: Tree Building -->
                    <div class="scan-section" id="treeBuildSection">
                    </div>

                    <!-- Section 4: EXTRA SETTINGS (PRM + Core + Alternate Pathways) -->
                    <div class="scan-section" id="prereqMasterSection" style="display:none;">
                        <div class="settings-block prm-block">
                            <div class="settings-block-header prm-header" id="prmToggleHeader">
                                <span class="settings-block-icon">[+]</span>
                                <span class="settings-block-title">Extra Settings</span>
                                <span class="prm-collapse-icon">[-]</span>
                            </div>
                            <div class="settings-block-content prm-content" id="prmContent">
                                <div class="setting-row prm-enable-row">
                                    <div class="setting-info">
                                        <span class="setting-label">Enable Lock Prerequisites</span>
                                        <span class="setting-desc">Auto-generates lock prereqs when building tree</span>
                                    </div>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="prmEnabled" checked>
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                <div class="prm-tabs">
                                    <button class="prm-tab active" data-prm-tab="locks">Pre Req Master</button>
                                    <button class="prm-tab" data-prm-tab="core">Core</button>
                                    <button class="prm-tab" data-prm-tab="altpaths">Alternate Pathways</button>
                                </div>
                                <div class="prm-split">
                                    <div class="prm-split-left">
                                        <div class="prm-tab-content" id="prmTabLocks">
                                            <div class="setting-row slider-row">
                                                <div class="setting-info"><span class="setting-label">Global Lock %</span></div>
                                                <div class="slider-container">
                                                    <input type="range" id="prmGlobalLockSlider" min="0" max="100" value="30" step="5" class="setting-slider">
                                                    <span id="prmGlobalLockValue" class="slider-value">30%</span>
                                                </div>
                                            </div>
                                            <div class="settings-subsection"><span class="subsection-title">Lock % by Tier</span></div>
                                            <div class="tier-xp-grid">
                                                <div class="tier-xp-item"><label for="prmTierNovice">Novice</label><input type="number" id="prmTierNovice" class="tier-xp-input" value="0" min="0" max="100"><span class="tier-xp-unit">%</span></div>
                                                <div class="tier-xp-item"><label for="prmTierApprentice">Apprentice</label><input type="number" id="prmTierApprentice" class="tier-xp-input" value="10" min="0" max="100"><span class="tier-xp-unit">%</span></div>
                                                <div class="tier-xp-item"><label for="prmTierAdept">Adept</label><input type="number" id="prmTierAdept" class="tier-xp-input" value="25" min="0" max="100"><span class="tier-xp-unit">%</span></div>
                                                <div class="tier-xp-item"><label for="prmTierExpert">Expert</label><input type="number" id="prmTierExpert" class="tier-xp-input" value="40" min="0" max="100"><span class="tier-xp-unit">%</span></div>
                                                <div class="tier-xp-item"><label for="prmTierMaster">Master</label><input type="number" id="prmTierMaster" class="tier-xp-input" value="50" min="0" max="100"><span class="tier-xp-unit">%</span></div>
                                            </div>
                                            <div class="setting-row">
                                                <div class="setting-info"><span class="setting-label">School Distribution</span></div>
                                                <select id="prmSchoolDistribution" class="setting-select">
                                                    <option value="proportional">Proportional</option>
                                                    <option value="even">Even</option>
                                                    <option value="random">Random</option>
                                                </select>
                                            </div>
                                            <div class="settings-subsection"><span class="subsection-title">Selection Pool</span></div>
                                            <div class="setting-row">
                                                <div class="setting-info"><span class="setting-label">Pool Source</span></div>
                                                <select id="prmPoolSource" class="setting-select">
                                                    <option value="same_school" selected>Same School</option>
                                                    <option value="any_school">Any School</option>
                                                    <option value="nearby">Nearby (layout distance)</option>
                                                </select>
                                            </div>
                                            <div class="setting-pair" id="prmNearbyControls">
                                                <div class="setting-row slider-row">
                                                    <div class="setting-info"><span class="setting-label">Distance</span></div>
                                                    <div class="slider-container">
                                                        <input type="range" id="prmDistanceSlider" min="50" max="500" value="200" step="25" class="setting-slider">
                                                        <span id="prmDistanceValue" class="slider-value">200</span>
                                                    </div>
                                                </div>
                                                <div class="setting-row slider-row">
                                                    <div class="setting-info"><span class="setting-label">Proximity Bias</span></div>
                                                    <div class="slider-container">
                                                        <input type="range" id="prmProximityBiasSlider" min="0" max="100" value="50" step="5" class="setting-slider">
                                                        <span id="prmProximityBiasValue" class="slider-value">50%</span>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="prm-tier-constraints">
                                                <label class="prm-constraint-toggle"><input type="checkbox" id="prmSameTier" checked><span class="toggle-slider-mini"></span><span>Same</span></label>
                                                <label class="prm-constraint-toggle"><input type="checkbox" id="prmPrevTier" checked><span class="toggle-slider-mini"></span><span>Prev</span></label>
                                                <label class="prm-constraint-toggle"><input type="checkbox" id="prmHigherTier"><span class="toggle-slider-mini"></span><span>Higher</span></label>
                                                <label class="prm-constraint-toggle"><input type="checkbox" id="prmAllowLockedLock"><span class="toggle-slider-mini"></span><span>Chain Locks</span></label>
                                            </div>
                                            <div class="prm-actions">
                                                <button id="prmApplyBtn" class="btn btn-primary" disabled><span class="btn-icon">[L]</span> Apply Locks</button>
                                                <button id="prmClearBtn" class="btn btn-secondary" disabled><span class="btn-icon">[X]</span> Clear</button>
                                                <span id="prmStatus" class="prm-status">Build a tree first</span>
                                            </div>
                                        </div>
                                        <div class="prm-tab-content" id="prmTabCore" style="display:none;">
                                            <div class="settings-subsection"><span class="subsection-title">Globe Position</span></div>
                                            <div class="setting-row slider-row">
                                                <div class="setting-info"><span class="setting-label">H Offset</span></div>
                                                <div class="slider-container">
                                                    <input type="range" id="prmGlobeHOffset" min="-500" max="500" value="0" step="5" class="setting-slider">
                                                    <span id="prmGlobeHValue" class="slider-value">0</span>
                                                </div>
                                            </div>
                                            <div class="setting-row slider-row">
                                                <div class="setting-info"><span class="setting-label">V Offset</span></div>
                                                <div class="slider-container">
                                                    <input type="range" id="prmGlobeVOffset" min="-500" max="500" value="0" step="5" class="setting-slider">
                                                    <span id="prmGlobeVValue" class="slider-value">0</span>
                                                </div>
                                            </div>
                                            <div class="setting-row slider-row">
                                                <div class="setting-info"><span class="setting-label">Radius</span></div>
                                                <div class="slider-container">
                                                    <input type="range" id="prmGlobeRadius" min="10" max="200" value="45" step="5" class="setting-slider">
                                                    <span id="prmGlobeRadiusValue" class="slider-value">45</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="prm-tab-content" id="prmTabAltPaths" style="display:none;">
                                            <div class="setting-row">
                                                <div class="setting-info">
                                                    <span class="setting-label">Bidirectional Soft Prerequisites</span>
                                                    <span class="setting-desc">Soft prereqs work both ways — mastering either side makes the other learnable</span>
                                                </div>
                                                <label class="toggle-switch">
                                                    <input type="checkbox" id="altPathsBidirectional" checked>
                                                    <span class="toggle-slider"></span>
                                                </label>
                                            </div>
                                            <div id="altPathsStats" class="prm-status" style="margin-top: 8px; font-size: 11px; color: var(--text-muted);"></div>
                                        </div>
                                    </div>
                                    <div class="prm-split-right" id="prmPreviewWrap"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Section 2b: Tree Growth -->
                    <div class="scan-section" id="treeGrowthSection">
                    </div>

                    <!-- Section 3: Output / Details -->
                    <div class="scan-section" id="scanDetailsSection">
                    </div>

                    <!-- Hidden output area used by Export Scan and C++ callbacks -->
                    <textarea id="outputArea" style="display:none;"></textarea>

                    <!-- Shared Build/Apply/Clear - Sticky at bottom -->
                    <div class="scan-actions-sticky scan-actions-bottom">
                        <!-- Scanner Presets row (hidden when no presets) -->
                        <div id="scannerPresetsRow" class="scanner-presets-row">
                            <span class="scanner-presets-label">PRESETS</span>
                            <button id="saveScannerPresetBtn" class="btn btn-sm scanner-preset-save-btn">[+] Save</button>
                            <div class="scanner-presets-divider"></div>
                            <div id="scannerPresetChips" class="scanner-preset-chips"></div>
                        </div>
                        <!-- Action buttons -->
                        <div class="scan-actions-buttons">
                            <button id="tgBuildBtn" class="btn" disabled>
                                <span class="btn-icon">[B]</span> Build Tree
                            </button>
                            <button id="tgApplyBtn" class="btn" disabled>
                                <span class="btn-icon">[A]</span> Apply Tree
                            </button>
                            <button id="tgClearBtn" class="btn btn-danger" disabled>
                                <span class="btn-icon">[X]</span> Clear Tree
                            </button>
                            <span style="margin-left:8px; font-size:11px;">Status: <span id="tgStatus" style="color:rgba(184,168,120,0.5);">Waiting for scan...</span></span>
                        </div>
                    </div>

                    </div><!-- /scannerComplexContent -->
                </div>

                <!-- PANEL: Spell Tree (default view) -->
                <div class="tab-content active" id="contentSpellTree">
                    <div id="tree-container" class="tree-container">
                        <svg id="tree-svg" class="tree-svg">
                            <defs>
                                <marker id="arrow" markerWidth="6" markerHeight="6" refX="5" refY="3"
                                        orient="auto" markerUnits="strokeWidth">
                                    <path d="M0,0 L0,6 L6,3 z" fill="#334155"/>
                                </marker>
                                <marker id="arrow-active" markerWidth="6" markerHeight="6" refX="5" refY="3"
                                        orient="auto" markerUnits="strokeWidth">
                                    <path d="M0,0 L0,6 L6,3 z" fill="#fbbf24"/>
                                </marker>
                                <filter id="glow" x="-50%" y="-50%" width="200%" height="200%">
                                    <feGaussianBlur stdDeviation="6" result="blur"/>
                                    <feMerge>
                                        <feMergeNode in="blur"/>
                                        <feMergeNode in="SourceGraphic"/>
                                    </feMerge>
                                </filter>
                            </defs>
                            <g id="wheel-group">
                                <g id="spokes-layer"></g>
                                <g id="edges-layer"></g>
                                <g id="nodes-layer"></g>
                            </g>
                            <g id="center-hub"></g>
                        </svg>

                        <div class="zoom-controls">
                            <button id="zoom-in" class="zoom-btn" title="Zoom In">+</button>
                            <span id="zoom-level">100%</span>
                            <button id="zoom-out" class="zoom-btn" title="Zoom Out">-</button>
                            <span id="renderer-badge" class="renderer-badge" title="Active renderer">SVG</span>
                            <button id="heart-settings-btn" class="zoom-btn" title="Heart Animation Settings">S</button>
                            <button id="edit-tree-btn" class="zoom-btn" title="Edit Tree">E</button>
                            <span id="edit-tools" class="edit-tools" style="display: none;">
                                <button id="edit-tool-move" class="zoom-btn edit-tool active" title="Move Tool">M</button>
                                <button id="edit-tool-pen" class="zoom-btn edit-tool" title="Pen Tool">P</button>
                                <button id="edit-tool-eraser" class="zoom-btn edit-tool" title="Eraser Tool">X</button>
                            </span>
                        </div>

                        <!-- Render Customization Settings Popup -->
                        <div id="heart-settings-popup" class="heart-settings-popup" style="display: none;">
                            <div class="popup-header">
                                <span>Render Customizations</span>
                                <button id="heart-settings-close" class="popup-close">x</button>
                            </div>
                            <div class="popup-content">
                                <div class="popup-section-title">Core</div>
                                <div class="popup-row-2">
                                    <div class="popup-cell"><label>Core Size</label>
                                        <input type="range" id="popup-core-size" min="20" max="80" step="5" value="50"><span id="popup-core-size-val">50</span>
                                    </div>
                                    <div class="popup-cell"><label>Particles</label>
                                        <input type="range" id="popup-globe-density" min="25" max="500" step="25" value="50"><span id="popup-globe-density-val">50</span>
                                    </div>
                                </div>
                                <div class="popup-row-3">
                                    <div class="popup-cell"><label>Animate</label>
                                        <label class="toggle-switch toggle-sm"><input type="checkbox" id="heart-animation-enabled" checked><span class="toggle-slider"></span></label>
                                    </div>
                                    <div class="popup-cell"><label>Bg Fill</label>
                                        <label class="toggle-switch toggle-sm"><input type="checkbox" id="popup-globe-bg-fill" checked><span class="toggle-slider"></span></label>
                                    </div>
                                    <div class="popup-cell"><label>Trail</label>
                                        <label class="toggle-switch toggle-sm"><input type="checkbox" id="popup-particle-trail" checked><span class="toggle-slider"></span></label>
                                    </div>
                                </div>
                                <div class="popup-row-2">
                                    <div class="popup-cell"><label>Speed</label>
                                        <input type="range" id="heart-pulse-speed" min="0" max="1" step="0.05" value="1"><span id="heart-pulse-speed-val">1.00</span>
                                    </div>
                                    <div class="popup-cell"><label>Delay</label>
                                        <input type="range" id="heart-pulse-delay" min="0" max="5" step="0.25" value="0.75"><span id="heart-pulse-delay-val">0.75s</span>
                                    </div>
                                </div>
                                <div class="popup-row-2">
                                    <div class="popup-cell"><label>Dot Min</label>
                                        <input type="range" id="popup-globe-dot-min" min="0.5" max="3" step="0.5" value="0.5"><span id="popup-globe-dot-min-val">0.5</span>
                                    </div>
                                    <div class="popup-cell"><label>Dot Max</label>
                                        <input type="range" id="popup-globe-dot-max" min="0.5" max="6" step="0.5" value="1"><span id="popup-globe-dot-max-val">1</span>
                                    </div>
                                </div>
                                <div class="popup-row-3">
                                    <div class="popup-cell"><label>Bg</label>
                                        <div class="color-swatch" id="heart-bg-color-swatch" data-target="heart-bg-color" style="background: #000000;"></div>
                                        <input type="hidden" id="heart-bg-color" value="#000000">
                                    </div>
                                    <div class="popup-cell"><label>Ring</label>
                                        <div class="color-swatch" id="heart-ring-color-swatch" data-target="heart-ring-color" style="background: #b8a878;"></div>
                                        <input type="hidden" id="heart-ring-color" value="#b8a878">
                                    </div>
                                    <div class="popup-cell"><label>Globe</label>
                                        <div class="color-swatch" id="globe-color-swatch" data-target="popup-globe-color" style="background: #b8a878;"></div>
                                        <input type="hidden" id="popup-globe-color" value="#b8a878">
                                    </div>
                                </div>
                                <div class="popup-row-3">
                                    <div class="popup-cell"><label>Path</label>
                                        <div class="color-swatch" id="learning-path-color-swatch" data-target="learning-path-color" style="background: #00ffff;"></div>
                                        <input type="hidden" id="learning-path-color" value="#00ffff">
                                    </div>
                                    <div class="popup-cell"><label>Txt</label>
                                        <div class="color-swatch" id="magic-text-color-swatch" data-target="popup-magic-text-color" style="background: #ffecb3;"></div>
                                        <input type="hidden" id="popup-magic-text-color" value="#ffecb3">
                                    </div>
                                    <div class="popup-cell"><label>TxtSz</label>
                                        <input type="range" id="popup-globe-text-size" min="8" max="32" step="1" value="16"><span id="popup-globe-text-size-val">16</span>
                                    </div>
                                </div>
                                <div class="popup-row"><label>Globe Text</label>
                                    <input type="text" id="popup-globe-text" class="popup-input" value="HEART" placeholder="Text">
                                </div>
                                <div class="popup-divider"></div>
                                <div class="popup-section-title">Starfield</div>
                                <div class="popup-row-3">
                                    <div class="popup-cell"><label>Enable</label>
                                        <label class="toggle-switch toggle-sm"><input type="checkbox" id="starfield-enabled" checked><span class="toggle-slider"></span></label>
                                    </div>
                                    <div class="popup-cell"><label>Fixed</label>
                                        <label class="toggle-switch toggle-sm"><input type="checkbox" id="starfield-fixed"><span class="toggle-slider"></span></label>
                                    </div>
                                    <div class="popup-cell"><label>Color</label>
                                        <div class="color-swatch" id="starfield-color-swatch" data-target="starfield-color" style="background: #ffffff;"></div>
                                        <input type="hidden" id="starfield-color" value="#ffffff">
                                    </div>
                                </div>
                                <div class="popup-row-2">
                                    <div class="popup-cell"><label>Density</label>
                                        <input type="range" id="starfield-density" min="50" max="500" step="25" value="200"><span id="starfield-density-val">200</span>
                                    </div>
                                    <div class="popup-cell"><label>Size</label>
                                        <input type="range" id="starfield-size" min="0.5" max="5" step="0.5" value="2.5"><span id="starfield-size-val">2.5</span>
                                    </div>
                                </div>
                                <div class="popup-row-2">
                                    <div class="popup-cell"><label>Seed</label>
                                        <input type="range" id="starfield-seed" min="1" max="999" step="1" value="42"><span id="starfield-seed-val">42</span>
                                    </div>
                                    <div class="popup-cell"><label>Bg</label>
                                        <div class="color-swatch" id="starfield-bg-color-swatch" data-target="starfield-bg-color" style="background: #000000;"></div>
                                        <input type="hidden" id="starfield-bg-color" value="#000000">
                                        <button class="popup-apply-btn" id="starfield-bg-apply" title="Apply">Apply</button>
                                    </div>
                                </div>
                                <div class="popup-divider"></div>
                                <div class="popup-section-title">Dividers</div>
                                <div class="popup-row-2">
                                    <div class="popup-cell"><label>Show</label>
                                        <label class="toggle-switch toggle-sm"><input type="checkbox" id="popup-show-dividers" checked><span class="toggle-slider"></span></label>
                                    </div>
                                    <div class="popup-cell"><label>Mode</label>
                                        <select id="popup-divider-color-mode" class="popup-select">
                                            <option value="school">School</option><option value="custom">Custom</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="popup-row-2">
                                    <div class="popup-cell"><label>Length</label>
                                        <input type="range" id="popup-divider-length" min="100" max="2000" step="50" value="1450"><span id="popup-divider-length-val">1450</span>
                                    </div>
                                    <div class="popup-cell"><label>Width</label>
                                        <input type="range" id="popup-divider-width" min="1" max="10" step="1" value="3"><span id="popup-divider-width-val">3px</span>
                                    </div>
                                </div>
                                <div class="popup-row-2">
                                    <div class="popup-cell"><label>Fade</label>
                                        <input type="range" id="popup-divider-fade" min="0" max="100" step="5" value="50"><span id="popup-divider-fade-val">50%</span>
                                    </div>
                                    <div class="popup-cell" id="popup-divider-custom-row" style="display: none;"><label>Color</label>
                                        <div class="color-swatch" id="divider-custom-color-swatch" data-target="popup-divider-custom-color" style="background: #ffffff;"></div>
                                        <input type="hidden" id="popup-divider-custom-color" value="#ffffff">
                                    </div>
                                </div>
                                <div class="popup-divider"></div>
                                <div class="popup-section-title">Connections</div>
                                <div class="popup-row-2">
                                    <div class="popup-cell"><label>Sel. Path</label>
                                        <label class="toggle-switch toggle-sm"><input type="checkbox" id="show-selection-path" checked><span class="toggle-slider"></span></label>
                                    </div>
                                    <div class="popup-cell"><label>Base Lines</label>
                                        <label class="toggle-switch toggle-sm"><input type="checkbox" id="show-base-connections" checked><span class="toggle-slider"></span></label>
                                    </div>
                                </div>
                                <div class="popup-divider"></div>
                                <div class="popup-section-title">Nodes</div>
                                <div class="popup-row-2">
                                    <div class="popup-cell"><label>Names</label>
                                        <label class="toggle-switch toggle-sm"><input type="checkbox" id="popup-show-node-names" checked><span class="toggle-slider"></span></label>
                                    </div>
                                    <div class="popup-cell"><label>Font</label>
                                        <input type="range" id="popup-node-font-size" min="6" max="18" step="1" value="13"><span id="popup-node-font-size-val">13</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Color Picker Modal -->
                        <div id="color-picker-modal" class="color-picker-modal" style="display: none;">
                            <div class="color-picker-content">
                                <div class="color-picker-header"><span>Select Color</span><button id="color-picker-close" class="popup-close">x</button></div>
                                <div class="color-picker-body">
                                    <div class="color-gradient" id="color-gradient"><div class="color-gradient-cursor" id="color-gradient-cursor"></div></div>
                                    <div class="color-hue-bar" id="color-hue-bar"><div class="color-hue-cursor" id="color-hue-cursor"></div></div>
                                    <div class="color-preview-row">
                                        <div class="color-preview" id="color-preview"></div>
                                        <input type="text" id="color-hex-input" class="color-hex-input" value="#ffffff" maxlength="7">
                                    </div>
                                    <div class="color-presets">
                                        <div class="color-preset" style="background:#ff0000" data-color="#ff0000"></div>
                                        <div class="color-preset" style="background:#ff8800" data-color="#ff8800"></div>
                                        <div class="color-preset" style="background:#ffff00" data-color="#ffff00"></div>
                                        <div class="color-preset" style="background:#00ff00" data-color="#00ff00"></div>
                                        <div class="color-preset" style="background:#00ffff" data-color="#00ffff"></div>
                                        <div class="color-preset" style="background:#0088ff" data-color="#0088ff"></div>
                                        <div class="color-preset" style="background:#8800ff" data-color="#8800ff"></div>
                                        <div class="color-preset" style="background:#ff00ff" data-color="#ff00ff"></div>
                                        <div class="color-preset" style="background:#ffffff" data-color="#ffffff"></div>
                                        <div class="color-preset" style="background:#b8a878" data-color="#b8a878"></div>
                                        <div class="color-preset" style="background:#1a1a2e" data-color="#1a1a2e"></div>
                                        <div class="color-preset" style="background:#0a0a14" data-color="#0a0a14"></div>
                                    </div>
                                    <button id="color-picker-apply" class="btn btn-primary btn-sm">Apply</button>
                                </div>
                            </div>
                        </div>

                        <div class="tree-instructions"><span>Drag to pan / Scroll to zoom / Click node to select</span></div>
                        <div id="empty-state" class="empty-state">
                            <div class="empty-icon">*</div>
                            <div class="empty-text">No spell tree loaded</div>
                            <div class="empty-hint">Scan your spells and build a tree to get started.</div>
                            <button id="go-to-scanner-btn" class="btn btn-primary">Go to Scanner</button>
                        </div>
                    </div>

                    <!-- Spell Details Sidebar -->
                    <div id="details-panel" class="details-panel hidden">
                        <div class="details-close"><button id="close-details" class="header-btn">x</button></div>
                        <div class="details-header">
                            <h3 id="spell-name">-</h3>
                            <span id="spell-school" class="school-badge">-</span>
                        </div>
                        <div class="details-body">
                            <div class="detail-row"><span class="detail-label">Level</span><span id="spell-level" class="detail-value">-</span></div>
                            <div class="detail-row"><span class="detail-label">Magicka</span><span id="spell-cost" class="detail-value">-</span></div>
                            <div class="detail-row"><span class="detail-label">Type</span><span id="spell-type" class="detail-value">-</span></div>
                            <div class="detail-section"><span class="detail-label">Effects</span><ul id="spell-effects" class="detail-list"></ul></div>
                            <div class="detail-section"><span class="detail-label">Description</span><p id="spell-description" class="detail-desc">-</p></div>
                            <div class="detail-section prereq-section">
                                <span class="detail-label">Prerequisites</span>
                                <div id="prereq-summary" class="prereq-summary"></div>
                                <div id="hard-prereqs-section" class="prereq-group hidden"><span class="prereq-type-label hard">Required (all)</span><ul id="hard-prereqs-list" class="detail-list clickable"></ul></div>
                                <div id="soft-prereqs-section" class="prereq-group hidden"><span class="prereq-type-label soft">Optional <span id="soft-needed-count"></span></span><ul id="soft-prereqs-list" class="detail-list clickable"></ul></div>
                                <ul id="spell-prereqs" class="detail-list clickable hidden"></ul>
                            </div>
                            <div class="detail-section"><span class="detail-label">Unlocks</span><ul id="spell-unlocks" class="detail-list clickable"></ul></div>
                        </div>
                        <div id="progress-section" class="progress-section hidden">
                            <div id="learning-status-container" class="learning-status-container">
                                <span id="learning-status-badge" class="learning-status-badge locked">LOCKED</span>
                                <span id="learning-effectiveness" class="learning-effectiveness"></span>
                            </div>
                            <div id="learning-status-hint" class="learning-status-hint"></div>
                            <div class="progress-label">
                                <span>Learning Progress</span>
                                <span id="progress-text" class="progress-text-normal">0 / 100 XP</span>
                                <span id="progress-edit" class="progress-edit hidden">
                                    <input type="number" id="xp-current-input" class="xp-input" min="0" value="0">
                                    <span>/</span>
                                    <input type="number" id="xp-required-input" class="xp-input xp-required" min="1" value="100">
                                    <span>XP</span>
                                </span>
                            </div>
                            <div class="progress-bar-container"><div id="progress-bar" class="progress-bar" style="width: 0%"></div></div>
                        </div>
                        <div class="details-footer">
                            <span id="spell-state" class="state-badge locked">Locked</span>
                            <button id="learn-btn" class="btn btn-learn hidden">Learn This</button>
                            <button id="unlock-btn" class="btn btn-unlock hidden" disabled>Unlock Spell</button>
                        </div>
                    </div>

                    <!-- How-to Panel -->
                    <div id="howto-panel" class="howto-panel hidden">
                        <div class="howto-tab" id="howto-tab"><span class="howto-tab-icon">?</span><span class="howto-tab-text">How to Learn</span></div>
                        <div class="howto-content">
                            <div class="howto-header"><h3>How to Learn Spells</h3><button id="close-howto" class="header-btn">x</button></div>
                            <div class="howto-section"><h4>[i] Current Settings</h4><ul id="howto-settings-list" class="howto-list"><li>Loading...</li></ul></div>
                            <div class="howto-section"><h4>[^] Gaining XP</h4><ul id="howto-xp-list" class="howto-list"><li>Loading...</li></ul></div>
                            <div class="howto-section"><h4>(!) Tips</h4><ul id="howto-tips-list" class="howto-list"><li>Set learning targets</li></ul></div>
                        </div>
                    </div>

                    <!-- Tree Footer -->
                    <div class="tree-footer">
                        <div class="footer-left">
                            <button id="import-btn" class="btn btn-secondary btn-sm"><span class="btn-icon">[v]</span> Import</button>
                            <button id="llm-toolbar-btn" class="btn btn-llm btn-sm hidden" title="LLM"><span class="btn-icon">[AI]</span> LLM</button>
                            <span class="spell-count"><span id="total-count">0</span> spells | <span id="unlocked-count">0</span> unlocked</span>
                        </div>
                        <div class="footer-center">
                            <div class="state-legend">
                                <span class="legend-item locked"><span class="legend-dot"></span>Locked</span>
                                <span class="legend-item available"><span class="legend-dot"></span>Available</span>
                                <span class="legend-item learning"><span class="legend-dot"></span>Learning</span>
                                <span class="legend-item unlocked"><span class="legend-dot"></span>Unlocked</span>
                            </div>
                        </div>
                        <div class="footer-right"><span id="tree-status-text" class="status-text">Ready</span></div>
                    </div>
                </div>

                <!-- TAB: Settings (stub - kept minimal for now) -->
                <div class="tab-content" id="contentSettings">
                    <div class="settings-block">
                        <div class="settings-block-header">
                            <span class="settings-block-icon">[D]</span>
                            <span class="settings-block-title">Dev Harness Mode</span>
                        </div>
                        <div class="settings-block-content">
                            <p style="color: var(--text-muted); padding: 12px;">Settings tab available - full settings from index.html can be ported as needed.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Resize Handle -->
            <div class="resize-handle" id="resizeHandle"></div>
        </div>
    </div>

    <!-- Modals -->
    <div id="import-modal" class="modal modal-fullpanel hidden">
        <div class="modal-backdrop"></div>
        <div class="modal-content modal-content-full">
            <div class="modal-header"><h3>Spell Tree JSON</h3><button class="modal-close" id="modal-close-btn">x</button></div>
            <div class="modal-body modal-body-full">
                <textarea id="import-textarea" class="json-editor" spellcheck="false" placeholder='{"version": "1.0", "schools": {...}}'></textarea>
                <div id="import-error" class="error-box hidden"></div>
            </div>
            <div class="modal-footer">
                <button id="import-confirm" class="btn btn-success">Save</button>
            </div>
        </div>
    </div>

    <div id="spawn-spell-modal" class="modal hidden">
        <div class="modal-backdrop"></div>
        <div class="modal-content spawn-modal">
            <div class="modal-header"><h3>Spawn Spell Node</h3><button class="modal-close" id="spawn-modal-close">x</button></div>
            <div class="modal-body">
                <input type="text" id="spawn-search" class="spawn-search" placeholder="Search spells...">
                <div id="spawn-spell-list" class="spawn-spell-list"><div class="spawn-loading">Loading spells...</div></div>
            </div>
            <div class="modal-footer"><button id="spawn-cancel" class="btn btn-secondary">Cancel</button></div>
        </div>
    </div>

    <!-- Preset Name Prompt Modal -->
    <div id="preset-name-modal" class="modal hidden">
        <div class="modal-backdrop"></div>
        <div class="modal-content" style="width: 320px;">
            <div class="modal-header">
                <h3 id="preset-name-title">Save Preset</h3>
                <button class="modal-close" id="preset-name-close">&times;</button>
            </div>
            <div class="modal-body" style="padding: 12px 16px;">
                <input type="text" id="preset-name-input" class="spawn-search" placeholder="Enter preset name..." style="width: 100%; margin-bottom: 0;">
            </div>
            <div class="modal-footer">
                <button id="preset-name-cancel" class="btn btn-secondary">Cancel</button>
                <button id="preset-name-confirm" class="btn btn-primary">Save</button>
            </div>
        </div>
    </div>

    <div id="blacklist-modal" class="modal hidden">
        <div class="modal-backdrop"></div>
        <div class="modal-content blacklist-modal">
            <div class="modal-header"><h3>Spell Blacklist</h3><button class="modal-close" id="blacklist-modal-close">x</button></div>
            <div class="modal-body">
                <input type="text" id="blacklist-search" class="spawn-search" placeholder="Search spells...">
                <div id="blacklist-search-results" class="spawn-spell-list blacklist-dropdown hidden"></div>
                <div class="blacklist-divider"></div>
                <div class="blacklist-list-header"><span>Blacklisted Spells</span><span id="blacklist-count" class="blacklist-count">0</span></div>
                <div id="blacklist-entries" class="blacklist-entries"><div class="blacklist-empty">No spells blacklisted</div></div>
            </div>
            <div class="modal-footer">
                <button id="blacklist-clear-all" class="btn btn-secondary">Clear All</button>
                <button id="blacklist-done" class="btn btn-primary">Done</button>
            </div>
        </div>
    </div>

    <div id="whitelist-modal" class="modal hidden">
        <div class="modal-backdrop"></div>
        <div class="modal-content whitelist-modal">
            <div class="modal-header"><h3>Plugin Whitelist</h3><button class="modal-close" id="whitelist-modal-close">x</button></div>
            <div class="modal-body">
                <div class="whitelist-info"><span class="whitelist-info-text">Select plugins to include.</span></div>
                <input type="text" id="whitelist-search" class="spawn-search" placeholder="Filter plugins...">
                <div class="whitelist-divider"></div>
                <div class="whitelist-section">
                    <div class="whitelist-section-header"><span>Base Game</span><span id="whitelist-base-count" class="whitelist-count">0</span></div>
                    <div id="whitelist-base-entries" class="whitelist-entries whitelist-base"></div>
                </div>
                <div class="whitelist-divider"></div>
                <div class="whitelist-section">
                    <div class="whitelist-section-header"><span>Mod Plugins</span><span id="whitelist-mod-count" class="whitelist-count">0</span></div>
                    <div id="whitelist-mod-entries" class="whitelist-entries whitelist-mods"><div class="whitelist-empty">Scan first</div></div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="whitelist-all" class="btn btn-secondary">All</button>
                <button id="whitelist-none" class="btn btn-secondary">None</button>
                <button id="whitelist-base-only" class="btn btn-secondary">Base Only</button>
                <button id="whitelist-done" class="btn btn-primary">Done</button>
            </div>
        </div>
    </div>

    <!-- Tooltip -->
    <div id="tooltip" class="tooltip hidden">
        <div class="tooltip-name"></div>
        <div class="tooltip-info"></div>
        <div class="tooltip-state"></div>
    </div>

    <!-- C++ Call Log Panel -->
    <div id="cpp-log">
        <div class="log-header">
            <span>C++ Bridge Log</span>
            <button id="btn-clear-log-inner" style="background:#21262d;border:1px solid #30363d;color:#c9d1d9;padding:2px 8px;border-radius:3px;cursor:pointer;font-size:11px;">Clear</button>
        </div>
        <div class="log-body" id="cpp-log-body"></div>
    </div>

    <!-- Module Loading - SAME order as index.html -->
    <script src="modules/constants.js"></script>
    <script src="modules/state.js"></script>
    <script src="modules/config.js"></script>
    <script src="modules/edgeScoring.js"></script>
    <script src="modules/shapeProfiles.js"></script>
    <script src="modules/layoutEngine.js"></script>
    <script src="modules/spellCache.js"></script>
    <script src="modules/colorUtils.js"></script>
    <script src="modules/uiHelpers.js"></script>
    <script src="modules/growthDSL.js"></script>
    <script src="modules/treeParser.js"></script>
    <script src="modules/wheelRenderer.js"></script>
    <script src="modules/starfield.js"></script>
    <script src="modules/globe3D.js"></script>
    <script src="modules/canvasRenderer.js"></script>
    <script src="modules/editMode.js"></script>
    <script src="modules/colorPicker.js"></script>
    <script src="modules/settingsPanel.js"></script>
    <script src="modules/treeViewerUI.js"></script>
    <script src="modules/progressionUI.js"></script>
    <script src="modules/settingsPresets.js"></script>
    <script src="modules/scannerPresets.js"></script>
    <script src="modules/easyMode.js"></script>
    <script src="modules/llmApiSettings.js"></script>
    <script src="modules/buttonHandlers.js"></script>
    <script src="modules/treePreviewUtils.js"></script>
    <script src="modules/sunGridLinear.js"></script>
    <script src="modules/sunGridEqualArea.js"></script>
    <script src="modules/sunGridFibonacci.js"></script>
    <script src="modules/sunGridSquare.js"></script>
    <script src="modules/treePreviewSun.js"></script>
    <script src="modules/treePreviewFlat.js"></script>
    <script src="modules/treePreview.js"></script>
    <script src="modules/treeCore.js"></script>
    <script src="modules/classic/classicRenderer.js"></script>
    <script src="modules/classic/classicLayout.js"></script>
    <script src="modules/classic/classicSettings.js"></script>
    <script src="modules/classic/classicMain.js"></script>
    <script src="modules/tree/treeRenderer.js"></script>
    <script src="modules/tree/treeTrunk.js"></script>
    <script src="modules/tree/treeSettings.js"></script>
    <script src="modules/treeGrowthTree.js"></script>
    <script src="modules/treeGrowth.js"></script>
    <script src="modules/cppCallbacks.js"></script>
    <script src="modules/llmIntegration.js"></script>
    <script src="modules/proceduralTreeBuilder.js"></script>
    <script src="modules/layoutGenerator.js"></script>
    <script src="modules/growthBehaviors.js"></script>
    <script src="modules/visualFirstBuilder.js"></script>
    <script src="modules/llmTreeFeatures.js"></script>
    <script src="modules/settingsAwareTreeBuilder.js"></script>
    <script src="modules/generationModeUI.js"></script>
    <script src="script.js"></script>
    <script src="modules/autoTest.js"></script>
    <script src="modules/unificationTest.js"></script>
    <script src="modules/main.js"></script>

    <!-- Harness toolbar wiring -->
    <script src="dev-harness-toolbar.js"></script>
</body>
</html>
